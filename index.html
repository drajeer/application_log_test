<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Log Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            background: #e8ecf1;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #000000;
            font-size: 2em;
            margin-bottom: 10px;
        }
        .main-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .btn {
            background: #2c4a6e;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            font-weight: 600;
        }
        .btn:hover {
            transform: translateY(-2px);
            background: #1c3a5e;
        }
        .btn-secondary {
            background: #8e7a6d;
        }
        .btn-secondary:hover {
            background: #7e6a5d;
        }
        .btn-tertiary {
            background: #5d7a9e;
        }
        .btn-tertiary:hover {
            background: #4d6a8e;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 20px;
        }
        .modal-content h2 {
            color: #2c4a6e;
            margin-bottom: 20px;
            text-align: center;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #2c4a6e;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .close-btn {
            background: #e0e0e0;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        .upload-zone {
            border: 3px dashed #5d7a9e;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f5f7f9;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        .upload-zone:hover {
            border-color: #2c4a6e;
            background: #eef1f5;
        }
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .section-title {
            color: #2c4a6e;
            font-size: 1.2em;
            margin: 25px 0 15px 0;
            font-weight: 600;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .log-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #5d7a9e;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .log-entry.status-acknowledged {
            border-left-color: #6d7a8a;
            background: #f5f7f9;
        }
        .log-entry.status-samples-received {
            border-left-color: #5d8a9e;
            background: #eff5f8;
        }
        .log-entry.status-scanning {
            border-left-color: #c9a86a;
            background: #f9f6ef;
        }
        .log-entry.status-scan-complete {
            border-left-color: #b8856d;
            background: #f8f3f0;
        }
        .log-entry.status-results-ready {
            border-left-color: #5d8a6d;
            background: #eff7f2;
        }
        .log-entry.status-data-transferred {
            border-left-color: #7d6d9a;
            background: #f4f1f7;
        }
        .log-entry:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .status-badge.acknowledged {
            background: #6d7a8a;
            color: white;
        }
        .status-badge.samples-received {
            background: #5d8a9e;
            color: white;
        }
        .status-badge.scanning {
            background: #c9a86a;
            color: white;
        }
        .status-badge.scan-complete {
            background: #b8856d;
            color: white;
        }
        .status-badge.results-ready {
            background: #5d8a6d;
            color: white;
        }
        .status-badge.data-transferred {
            background: #7d6d9a;
            color: white;
        }
        .log-entry h3 {
            color: #2c4a6e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .log-entry.deleted {
            background: #a0a0a0 !important;
            border-left-color: #5a5a5a !important;
            opacity: 0.5 !important;
        }
        .log-entry.deleted h3 {
            color: #5a5a5a !important;
        }
        .log-entry.deleted .status-badge {
            background: #7a7a7a !important;
        }
        .log-entry.deleted .log-detail {
            color: #888 !important;
        }
        .log-entry.deleted .log-detail strong {
            color: #777 !important;
        }
        .deleted-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 700;
            background: #5a5a5a;
            color: white;
            margin-right: 10px;
            text-transform: uppercase;
        }
        
        .data-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            gap: 5px;
        }
        .data-indicator.stored {
            background: #dfe5e9;
            color: #2c4a6e;
            border: 1px solid #c5d0d8;
        }
        .data-indicator.deleted {
            background: #e8d9da;
            color: #6d4a4b;
            border: 1px solid #d5c0c1;
        }
        .data-indicator.warning {
            background: #e9e3d5;
            color: #6d5f4a;
            border: 1px solid #d8ceb8;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .log-entry.compact {
            padding: 15px 20px;
        }
        .log-entry.compact h3 {
            margin-bottom: 0;
            display: inline;
            font-size: 1em;
        }
        .log-entry.compact .log-detail {
            display: none;
        }
        .log-entry.compact p {
            display: none;
        }
        .log-entry.compact .status-badge {
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #2c4a6e;
        }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }
        .toggle-label {
            font-weight: 600;
            color: #333;
        }
        .log-detail {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.95em;
        }
        .log-detail strong {
            color: #555;
        }
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 30px; flex-wrap: wrap;">
<div style="flex: 0 0 120px;">
    <img src="https://nxct.ac.uk/wp-content/uploads/2020/11/nxct-organisation-logo.png" 
         alt="NXCT Logo" 
         style="width: 240px; height: 160px; object-fit: contain; border-radius: 8px;">
</div>
                <div style="flex: 1; text-align: center;">
                    <h1>UCL NXCT Experiment Log</h1>
                </div>
                <div style="flex: 0 0 120px;">
    <img src="https://cdn.prod.website-files.com/65646dbd542e223348a87bae/65646dbd542e223348a87c3f_UCL_logo-p-500.png" 
         alt="NXCT Organisation Logo" 
         style="width: 240px; height: 160px; object-fit: contain; border-radius: 8px;">
</div>
            </div>
        </div>
        <div class="main-content">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <button class="btn" onclick="showApplicationChoice()">+ New Application</button>
                <button class="btn btn-tertiary" onclick="exportToExcel()" style="background: #4a7c59;">📊 Export to Excel</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importExcelInput').click()" style="background: #8e7a6d;">📥 Import from Excel</button>
                <button class="btn btn-tertiary" onclick="showSheetImportModal()" style="background: #4a597c;">📥 Import from Sheet</button>
                <button class="btn" onclick="showAnalysis()" style="background: #5d8a9e;">📈 Analysis</button>
                <button class="btn" onclick="showMaintenance()" style="background: #c94a4a;">🔧 Maintenance</button>
                <button class="btn" onclick="generateTestData()" style="background: #b8856d; font-size: 0.9em; padding: 12px 20px;">Generate Test Data</button>
                <input type="file" id="importExcelInput" accept=".xlsx, .xls" style="display: none;">
            </div>
            <div style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #333; margin: 0;">Application Log</h2>
                    <div class="view-toggle">
                        <span class="toggle-label">Compact View</span>
                        <div class="toggle-switch" id="viewToggle" onclick="toggleView()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                <div id="logsList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="applicationTypeModal">
        <div class="modal-content">
            <h2>Select Application Type</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Choose the type of application</p>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="selectNXCT()">NXCT</button>
                <button class="btn btn-tertiary" onclick="selectInternal()">Internal</button>
            </div>
            <button class="close-btn" onclick="closeModal('applicationTypeModal')" style="width: 100%; margin-top: 10px;">Cancel</button>
        </div>
    </div>

    <div class="modal" id="nxctModal">
        <div class="modal-content">
            <h2>NXCT Application</h2>
            <div class="upload-zone" onclick="document.getElementById('pdfInput').click()">
                <input type="file" id="pdfInput" accept=".pdf" multiple style="display: none;">
                <div style="font-size: 3em; margin-bottom: 15px;">📄</div>
                <p style="font-size: 1.2em; font-weight: 600; color: #2c4a6e;">Upload NXCT Application PDF(s)</p>
                <p style="color: #666;">Click to browse or drag and drop (multiple files supported)</p>
            </div>
            <div id="uploadStatus" class="status-message"></div>
            <div id="extractedDataForm" style="display: none; position: relative; padding-bottom: 80px;">
                <div class="section-title">Application Details</div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Application Number:</label>
                        <input type="text" id="appNumber" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="input-group">
                        <label>Date Received:</label>
                        <input type="text" id="dateReceived" readonly style="background: #f5f5f5;">
                    </div>
                </div>
                <div class="section-title">Applicant Details</div>
                <div class="input-group">
                    <label>Full Name:</label>
                    <input type="text" id="fullName">
                </div>
                <div class="input-group">
                    <label>Organisation:</label>
                    <input type="text" id="organisation">
                </div>
                <div class="input-group">
                    <label>Email Address:</label>
                    <input type="text" id="email">
                </div>
                <div class="section-title">Project Details</div>
                <div class="input-group">
                    <label>Project Title:</label>
                    <input type="text" id="projectTitle">
                </div>
                <div class="input-group">
                    <label>Project Description:</label>
                    <textarea id="projectDescription" rows="6"></textarea>
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Primary Subject Sector:</label>
                        <input type="text" id="subjectSector">
                    </div>
                    <div class="input-group">
                        <label>Type of Work:</label>
                        <input type="text" id="typeOfWork">
                    </div>
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Free Beamtime Access:</label>
                        <input type="text" id="freeBeamtime">
                    </div>
                    <div class="input-group">
                        <label>Expected Days Needed:</label>
                        <input type="text" id="daysNeeded">
                    </div>
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Equipment Requested:</label>
                        <input type="text" id="equipment">
                    </div>
                    <div class="input-group">
                        <label>Previous XCT Experience:</label>
                        <input type="text" id="previousExperience">
                    </div>
                </div>
                <div class="section-title">Sample Details</div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Number of Samples:</label>
                        <input type="text" id="numSamples">
                    </div>
                    <div class="input-group">
                        <label>Sample Composition:</label>
                        <input type="text" id="sampleComposition">
                    </div>
                </div>
                <div class="input-group">
                    <label>Sample Shape and Dimensions:</label>
                    <input type="text" id="sampleDimensions">
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Hazardous Samples:</label>
                        <input type="text" id="hazardous">
                    </div>
                    <div class="input-group">
                        <label>Samples Ready:</label>
                        <input type="text" id="samplesReady">
                    </div>
                </div>
                <div class="input-group">
                    <label>Ready Date:</label>
                    <input type="text" id="readyDate">
                </div>
                <div class="input-group">
                    <label>Feature Size:</label>
                    <textarea id="featureSize" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>Scanning Area:</label>
                    <input type="text" id="scanningArea">
                </div>
                <div class="input-group">
                    <label>Analysis Help Needed:</label>
                    <input type="text" id="analysisHelp">
                </div>
                <div class="input-group">
                    <label>Analysis Details:</label>
                    <textarea id="analysisDetails" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>Additional Notes:</label>
                    <textarea id="additionalNotes" rows="3"></textarea>
                </div>
                <div style="position: sticky; bottom: 0; right: 0; background: white; padding: 20px 0; margin-top: 20px; border-top: 2px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 15px;">
                    <button class="close-btn" onclick="closeModal('nxctModal')">Cancel</button>
                    <button class="btn" onclick="saveNXCTApplication()">Save Application</button>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal('nxctModal')" style="width: 100%;" id="cancelUploadBtn">Cancel</button>
        </div>
    </div>

    <div class="modal" id="internalModal">
        <div class="modal-content">
            <h2>Internal Application</h2>
            <div style="background: #e7f1ff; border: 2px solid #0d6efd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="margin: 0; color: #0d6efd; font-weight: 600;">Internal Number: <span id="internalNumberDisplay">Will be assigned on save</span></p>
            </div>
            
            <div class="input-group">
                <label>Experiment Title:</label>
                <input type="text" id="internalTitle" placeholder="Enter experiment title">
            </div>
            
            <div class="input-group">
                <label>Experiment Lead:</label>
                <input type="text" id="internalLead" placeholder="Enter name of experiment lead" required>
            </div>
            
            <div class="input-group">
                <label>Organisation:</label>
                <input type="text" id="internalOrganisation" value="University College London">
            </div>
            
            <div class="input-group">
                <label>Email Address:</label>
                <input type="email" id="internalEmail" placeholder="Enter email address" required>
            </div>
            
            <div class="input-group">
                <label>System Used:</label>
                <select id="internalSystem">
                    <option value="">Select system...</option>
                    <option value="Microscope">Microscope</option>
                    <option value="Large Field of View">Large Field of View</option>
                    <option value="Medium Field of View">Medium Field of View</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Expected Days:</label>
                <input type="number" id="internalDays" placeholder="Enter expected days" min="1">
            </div>
            
            <div class="input-group">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600; color: #333;">Free</span>
                    <div class="toggle-switch" id="beamtimeToggle" onclick="toggleBeamtime()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span style="font-weight: 600; color: #333;">Paid</span>
                </div>
            </div>
            
            <div class="input-group">
                <label>Brief Experiment Description:</label>
                <textarea id="internalNotes" placeholder="Brief description of the experiment" rows="4"></textarea>
            </div>
            
            <div class="button-group">
                <button class="btn" onclick="saveInternal()">Save</button>
                <button class="close-btn" onclick="closeModal('internalModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="viewDetailsModal">
        <div class="modal-content">
            <h2 id="viewDetailsTitle">Application Details</h2>
            <div id="viewDetailsContent"></div>
            <button class="close-btn" onclick="closeModal('viewDetailsModal')" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>

    <div class="modal" id="analysisModal">
        <div class="modal-content" style="max-width: 1100px;">
            <h2>Analysis Dashboard</h2>
            <div id="analysisContent"></div>
            <button class="close-btn" onclick="closeModal('analysisModal')" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>

    <div class="modal" id="maintenanceModal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>Maintenance Schedule</h2>
            
            <div style="margin-bottom: 30px;">
                <h3 style="color: #2c4a6e; margin-bottom: 15px;">Add New Maintenance</h3>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <strong id="dateRangeDisplay" style="color: #2c4a6e; font-size: 1.1em;">Click on calendar to select start date</strong>
                    </div>
                    <div id="maintenanceCalendar"></div>
                </div>
                
                <div class="input-group">
                    <label>Description:</label>
                    <textarea id="maintenanceDescription" rows="3" placeholder="Brief description of maintenance work"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="addMaintenance()" style="background: #c94a4a;">Add Maintenance</button>
                    <button class="btn" onclick="resetCalendar()" style="background: #8e7a6d;">Reset Dates</button>
                </div>
            </div>
            
            <div style="border-top: 2px solid #e0e0e0; padding-top: 20px;">
                <h3 style="color: #2c4a6e; margin-bottom: 15px;">Scheduled Maintenance</h3>
                <div id="maintenanceList"></div>
            </div>
            
            <button class="close-btn" onclick="closeModal('maintenanceModal')" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>

    <div class="modal" id="sheetImportModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>Import Data from Google Sheet</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter the Google Sheet ID (the long string in the URL between `/d/` and `/edit`).</p>
            <div class="input-group">
                <label>Sheet ID:</label>
                <input type="text" id="sheetIdInput" placeholder="e.g., 1yC5b3X3J7mZt...-s3Q" required>
            </div>
            <div id="sheetStatus" class="status-message"></div>
            <div class="button-group">
                <button class="btn" onclick="importFromSheet()">Import Data</button>
                <button class="close-btn" onclick="closeModal('sheetImportModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        let experimentLogs = [];
        let compactView = true;
        let internalCounter = 0;
        let maintenanceRecords = [];
        let selectedStartDate = null;
        let selectedEndDate = null;
        let currentCalendarMonth = new Date();

        function clearHighlightOnInput(field) {
            field.style.borderColor = '#e0e0e0';
            field.style.borderWidth = '2px';
            field.style.boxShadow = 'none';
        }

        function initializeInternalCounter() {
            let maxNum = 0;
            experimentLogs.forEach(log => {
                if (log.type === 'Internal' && log.data.internalNumber) {
                    const num = parseInt(log.data.internalNumber);
                    if (num > maxNum) maxNum = num;
                }
            });
            internalCounter = maxNum;
        }

        function getNextInternalNumber() {
            internalCounter++;
            return String(internalCounter).padStart(4, '0');
        }

        function showApplicationChoice() {
            document.getElementById('applicationTypeModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'nxctModal') {
                document.getElementById('pdfInput').value = '';
                document.getElementById('uploadStatus').style.display = 'none';
                document.getElementById('extractedDataForm').style.display = 'none';
                document.getElementById('cancelUploadBtn').style.display = 'block';
            }
            if (modalId === 'internalModal') {
                document.getElementById('internalNumberDisplay').textContent = 'Will be assigned on save';
            }
            if (modalId === 'analysisModal') {
                const analysisContent = document.getElementById('analysisContent');
                analysisContent.innerHTML = '';
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                const modals = document.querySelectorAll('.modal.active');
                modals.forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        function selectNXCT() {
            closeModal('applicationTypeModal');
            document.getElementById('nxctModal').classList.add('active');
        }

        function selectInternal() {
            closeModal('applicationTypeModal');
            
            const nextNumber = String(internalCounter + 1).padStart(4, '0');
            document.getElementById('internalNumberDisplay').textContent = nextNumber;
            
            document.getElementById('internalModal').classList.add('active');
        }

        document.getElementById('pdfInput').addEventListener('change', handlePDFUpload);
        document.getElementById('importExcelInput').addEventListener('change', handleExcelImport);

        async function handlePDFUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            showStatus(`Processing ${files.length} PDF file(s)...`, 'info');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    showStatus(`Processing ${i + 1} of ${files.length}: ${file.name}...`, 'info');
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    for (let j = 1; j <= pdf.numPages; j++) {
                        const page = await pdf.getPage(j);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    extractDataFromText(fullText);
                    successCount++;
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    errorCount++;
                }
            }
            
            if (errorCount === 0) {
                showStatus(`✓ Successfully extracted data from ${successCount} PDF(s)! Review below and click Save.`, 'success');
            } else {
                showStatus(`⚠ Extracted ${successCount} successfully, ${errorCount} failed.`, 'info');
            }
            
            document.getElementById('extractedDataForm').style.display = 'block';
            document.getElementById('cancelUploadBtn').style.display = 'none';
        }

        function extractDataFromText(text) {
            function cleanText(str) {
                if (!str) return '';
                str = str.replace(/\*/g, '').replace(/\?/g, '').replace(/\s+/g, ' ').trim();
                str = str.replace(/Applicant Details/gi, '');
                str = str.replace(/Project Details/gi, '');
                str = str.replace(/\(length x width x height\)/gi, '');
                str = str.replace(/for scanning\/shipped to the facility/gi, '');
                str = str.replace(/\(whole sample, region of interest, other\)/gi, '');
                return str.trim();
            }

            function extractBetween(text, startLabel, endLabel) {
                const start = startLabel.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const end = endLabel.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(start + '\\s*\\*?\\s*([\\s\\S]*?)(?=' + end + '|$)', 'i');
                const match = text.match(regex);
                return match ? cleanText(match[1]) : '';
            }

            document.getElementById('appNumber').value = extractBetween(text, 'APPLICATION NUMBER', 'DATE RECEIVED');
            document.getElementById('dateReceived').value = extractBetween(text, 'DATE RECEIVED', 'Full Name');
            document.getElementById('fullName').value = extractBetween(text, 'Full Name', 'Organisation');
            document.getElementById('organisation').value = extractBetween(text, 'Organisation', 'Email Address');
            document.getElementById('email').value = extractBetween(text, 'Email Address', 'Project Title');
            document.getElementById('projectTitle').value = extractBetween(text, 'Project Title', 'Project Description');
            
            let desc = extractBetween(text, 'Project Description', 'Primary Subject Sector');
            desc = desc.replace(/in\s+ammatory/g, 'inflammatory').replace(/e\s+cacy/g, 'efficacy').replace(/\s+rst/g, ' first');
            document.getElementById('projectDescription').value = desc;
            
            document.getElementById('subjectSector').value = extractBetween(text, 'Primary Subject Sector', 'Answer if');
            document.getElementById('typeOfWork').value = extractBetween(text, 'Type of Work', 'Applying for the NXCT Free Beamtime Access Scheme');
            document.getElementById('freeBeamtime').value = extractBetween(text, 'Applying for the NXCT Free Beamtime Access Scheme', 'If an SME');
            document.getElementById('daysNeeded').value = extractBetween(text, 'Expected number of days needed', 'Requested date of completion');
            
            let equipment = text.match(/Piece\s*\(\s*s\s*\)\s*of equipment requested[^*]*\*?\s*([^\n]+?)\s*NXCT facility equipment is based at/i);
            if (equipment) {
                document.getElementById('equipment').value = cleanText(equipment[1]);
            }

            document.getElementById('previousExperience').value = extractBetween(text, 'Any previous experience with X-ray Computed Tomography', 'If yes, details of previous experience');
            document.getElementById('numSamples').value = extractBetween(text, 'Number of samples', 'Sample shape and dimension');
            document.getElementById('sampleDimensions').value = extractBetween(text, 'Sample shape and dimension', 'Sample composition');
            document.getElementById('sampleComposition').value = extractBetween(text, 'Sample composition', 'Hazardous samples');
            document.getElementById('hazardous').value = extractBetween(text, 'Hazardous samples', 'If yes, details of hazardous samples');
            
            let scanArea = text.match(/Scanning area[^)]*\)\s*\*?\s*([^\n]+?)\s*Sample\s*\(\s*s\s*\)\s*ready/i);
            if (scanArea) {
                document.getElementById('scanningArea').value = cleanText(scanArea[1]);
            }
            
            let samplesReady = text.match(/Sample\s*\(\s*s\s*\)\s*ready\s*\*?\s*([^\n]+?)\s*Date when samples will be ready/i);
            if (samplesReady) {
                document.getElementById('samplesReady').value = cleanText(samplesReady[1]);
            }
            
            document.getElementById('readyDate').value = extractBetween(text, 'Date when samples will be ready', 'Size of feature');
            
            let featureSize = text.match(/Size of feature\s*\(\s*s\s*\)\s*\*?\s*([\s\S]+?)\s*In-situ or rig-only experiment/i);
            if (featureSize) {
                document.getElementById('featureSize').value = cleanText(featureSize[1]);
            }

            document.getElementById('analysisHelp').value = extractBetween(text, 'Analysis help needed', 'If yes or not sure, details of analysis help needed');
            document.getElementById('analysisDetails').value = extractBetween(text, 'If yes or not sure, details of analysis help needed', 'Details of any previous NXCT work');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message status-' + type;
            statusDiv.style.display = 'block';
        }

        function saveNXCTApplication() {
            const data = {
                appNumber: document.getElementById('appNumber').value,
                dateReceived: document.getElementById('dateReceived').value,
                fullName: document.getElementById('fullName').value,
                organisation: document.getElementById('organisation').value,
                email: document.getElementById('email').value,
                projectTitle: document.getElementById('projectTitle').value,
                projectDescription: document.getElementById('projectDescription').value,
                subjectSector: document.getElementById('subjectSector').value,
                typeOfWork: document.getElementById('typeOfWork').value,
                freeBeamtime: document.getElementById('freeBeamtime').value,
                daysNeeded: document.getElementById('daysNeeded').value,
                equipment: document.getElementById('equipment').value,
                previousExperience: document.getElementById('previousExperience').value,
                numSamples: document.getElementById('numSamples').value,
                sampleComposition: document.getElementById('sampleComposition').value,
                sampleDimensions: document.getElementById('sampleDimensions').value,
                hazardous: document.getElementById('hazardous').value,
                samplesReady: document.getElementById('samplesReady').value,
                readyDate: document.getElementById('readyDate').value,
                featureSize: document.getElementById('featureSize').value,
                scanningArea: document.getElementById('scanningArea').value,
                analysisHelp: document.getElementById('analysisHelp').value,
                analysisDetails: document.getElementById('analysisDetails').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                
                status: 'Acknowledged',
                completionDate: '',
                actualDays: '',
                dataSize: '',
                analysisTime: '',
                dataDeleted: 'No',
                statusLog: [{ status: 'Acknowledged', date: new Date().toLocaleString() }]
            };

            experimentLogs.unshift({
                type: 'NXCT',
                timestamp: new Date().toLocaleString(),
                data
            });
            
            renderLogs();
            document.getElementById('pdfInput').value = '';
            document.getElementById('extractedDataForm').style.display = 'none';
            document.getElementById('cancelUploadBtn').style.display = 'block';
            closeModal('nxctModal');
            // alert('NXCT Application saved successfully!');
        }

        function saveNXCTApplicationSilent(logData) {
            const data = {
                appNumber: logData['Application Number'] || '',
                dateReceived: logData['Date Received'] || '',
                fullName: logData['Full Name'] || '',
                organisation: logData['Organisation'] || '',
                email: logData['Email Address'] || '',
                projectTitle: logData['Project Title'] || '',
                projectDescription: logData['Project Description'] || '',
                subjectSector: logData['Primary Subject Sector'] || '',
                typeOfWork: logData['Type of Work'] || '',
                freeBeamtime: logData['Free Beamtime Access'] || '',
                daysNeeded: logData['Expected Days Needed'] || '',
                equipment: logData['Equipment Requested'] || '',
                previousExperience: logData['Previous XCT Experience'] || '',
                numSamples: logData['Number of Samples'] || '',
                sampleComposition: logData['Sample Composition'] || '',
                sampleDimensions: logData['Sample Shape and Dimensions'] || '',
                hazardous: logData['Hazardous Samples'] || '',
                samplesReady: logData['Samples Ready'] || '',
                readyDate: logData['Ready Date'] || '',
                featureSize: logData['Feature Size'] || '',
                scanningArea: logData['Scanning Area'] || '',
                analysisHelp: logData['Analysis Help Needed'] || '',
                analysisDetails: logData['Analysis Details'] || '',
                additionalNotes: logData['Additional Notes'] || '',
                
                status: logData['Status'] || 'Acknowledged',
                completionDate: logData['Completion Date'] || '',
                actualDays: logData['Actual Days'] || '',
                dataSize: logData['Data Size'] || '',
                analysisTime: logData['Analysis Time'] || '',
                dataDeleted: logData['Data Deleted'] || 'No',

                statusLog: [{ status: logData['Status'] || 'Acknowledged', date: new Date().toLocaleString() }]
            };

            experimentLogs.unshift({
                type: 'NXCT',
                timestamp: new Date().toLocaleString(),
                data
            });
        }
        
        function saveInternal() {
            const title = document.getElementById('internalTitle').value.trim();
            const lead = document.getElementById('internalLead').value.trim();
            const organisation = document.getElementById('internalOrganisation').value.trim();
            const email = document.getElementById('internalEmail').value.trim();
            const system = document.getElementById('internalSystem').value;
            const expectedDays = document.getElementById('internalDays').value;
            const beamtimeToggle = document.getElementById('beamtimeToggle');
            const beamtime = beamtimeToggle.classList.contains('active') ? 'Paid' : 'Free';
            const notes = document.getElementById('internalNotes').value.trim();

            if (!title || !lead || !email) {
                alert('Please fill in Experiment Title, Lead, and Email.');
                // Simple highlighting of required fields
                if (!title) document.getElementById('internalTitle').style.borderColor = 'red';
                if (!lead) document.getElementById('internalLead').style.borderColor = 'red';
                if (!email) document.getElementById('internalEmail').style.borderColor = 'red';
                return;
            }
            
            const internalNumber = getNextInternalNumber();

            const data = {
                internalNumber: internalNumber,
                title: title,
                lead: lead,
                organisation: organisation,
                email: email,
                system: system,
                expectedDays: expectedDays,
                beamtime: beamtime,
                notes: notes,
                
                status: 'Acknowledged',
                completionDate: '',
                actualDays: '',
                dataSize: '',
                analysisTime: '',
                dataDeleted: 'No',
                statusLog: [{ status: 'Acknowledged', date: new Date().toLocaleString() }]
            };

            experimentLogs.unshift({
                type: 'Internal',
                timestamp: new Date().toLocaleString(),
                data
            });
            
            // Clear form
            document.getElementById('internalTitle').value = '';
            document.getElementById('internalLead').value = '';
            document.getElementById('internalEmail').value = '';
            document.getElementById('internalSystem').value = '';
            document.getElementById('internalDays').value = '';
            document.getElementById('internalNotes').value = '';
            
            renderLogs();
            closeModal('internalModal');
            // alert(`Internal Application ${internalNumber} saved successfully!`);
        }

        function toggleBeamtime() {
            document.getElementById('beamtimeToggle').classList.toggle('active');
        }

        function renderLogs() {
            const logsList = document.getElementById('logsList');
            if (experimentLogs.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px; font-size: 1.1em;">No application logs found. Use the buttons above to add new data.</p>';
                return;
            }

            logsList.innerHTML = experimentLogs.map((log, index) => {
                const statusClass = log.data.status.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const isDeleted = log.data.dataDeleted && log.data.dataDeleted.toLowerCase() === 'yes';
                const compactClass = compactView ? ' compact' : '';
                const deletedClass = isDeleted ? ' deleted' : '';
                const hasWarning = log.data.status.toLowerCase() === 'samples-received' && !log.data.completionDate; // Example warning logic

                let title = log.type === 'NXCT' ? 
                            `${log.data.appNumber || 'No App #'} - ${log.data.projectTitle || 'No Project Title'}` :
                            `Internal App ${log.data.internalNumber || 'No ID'} - ${log.data.title || 'No Title'}`;
                
                let details = '';
                if (log.type === 'NXCT') {
                    details = `
                        <div class="log-detail">
                            <strong>Applicant:</strong> <span>${log.data.fullName || 'N/A'} (${log.data.organisation || 'N/A'})</span>
                        </div>
                        <div class="log-detail">
                            <strong>Date Received:</strong> <span>${log.data.dateReceived || 'N/A'}</span>
                        </div>
                        <div class="log-detail">
                            <strong>Expected Days:</strong> <span>${log.data.daysNeeded || 'N/A'}</span>
                        </div>
                        <div class="log-detail">
                            <strong>Equipment:</strong> <span>${log.data.equipment || 'N/A'}</span>
                        </div>
                    `;
                } else {
                    details = `
                        <div class="log-detail">
                            <strong>Lead:</strong> <span>${log.data.lead || 'N/A'} (${log.data.organisation || 'N/A'})</span>
                        </div>
                        <div class="log-detail">
                            <strong>System Used:</strong> <span>${log.data.system || 'N/A'}</span>
                        </div>
                        <div class="log-detail">
                            <strong>Beamtime:</strong> <span>${log.data.beamtime || 'N/A'}</span>
                        </div>
                        <div class="log-detail">
                            <strong>Expected Days:</strong> <span>${log.data.expectedDays || 'N/A'}</span>
                        </div>
                    `;
                }

                const dataIndicator = log.data.dataDeleted && log.data.dataDeleted.toLowerCase() === 'yes' ? 
                    `<span class="data-indicator deleted">Data Deleted</span>` :
                    (log.data.dataSize ? `<span class="data-indicator stored">${log.data.dataSize} Stored</span>` : `<span class="data-indicator warning">No Data Recorded</span>`);

                const deletedBadge = isDeleted ? `<span class="deleted-badge">DELETED</span>` : '';

                return `
                    <div class="log-entry status-${statusClass}${compactClass}${deletedClass}" onclick="viewDetails(${index})">
                        <h3>
                            ${deletedBadge}
                            <span class="status-badge ${statusClass}">${log.data.status}</span>
                            ${title}
                        </h3>
                        ${!compactView ? details : ''}
                        <p style="margin-top: ${!compactView ? '10px' : '0'}; color: #666; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                            <span>Logged: ${log.timestamp}</span>
                            ${!compactView ? dataIndicator : ''}
                        </p>
                    </div>
                `;
            }).join('');

            localStorage.setItem('experimentLogs', JSON.stringify(experimentLogs));
            localStorage.setItem('internalCounter', internalCounter);
            
            renderAnalysis();
        }

        function toggleView() {
            compactView = !compactView;
            document.getElementById('viewToggle').classList.toggle('active', compactView);
            renderLogs();
        }

        function viewDetails(index) {
            const log = experimentLogs[index];
            const modalTitle = log.type === 'NXCT' ? 
                `NXCT Application: ${log.data.appNumber || 'No App #'}` :
                `Internal Application: ${log.data.internalNumber || 'No ID'}`;
            
            document.getElementById('viewDetailsTitle').textContent = modalTitle;
            
            let htmlContent = `<p style="color: #666; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px;">Logged on: ${log.timestamp}</p>`;
            
            // Status update section
            htmlContent += `
                <div class="section-title" style="margin-top: 0; padding-top: 0; border-top: none;">Update Status</div>
                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <select id="newStatus" style="flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                        <option value="Acknowledged">Acknowledged</option>
                        <option value="Samples Received">Samples Received</option>
                        <option value="Scanning">Scanning</option>
                        <option value="Scan Complete">Scan Complete</option>
                        <option value="Results Ready">Results Ready</option>
                        <option value="Data Transferred">Data Transferred</option>
                    </select>
                    <button class="btn" style="padding: 10px 20px; font-size: 1em;" onclick="updateStatus(${index})">Update Status</button>
                    ${log.data.dataDeleted && log.data.dataDeleted.toLowerCase() === 'yes' ? 
                        `<button class="btn" style="padding: 10px 20px; font-size: 1em; background: #c94a4a;" onclick="restoreLog(${index})">Restore Log</button>` :
                        `<button class="btn" style="padding: 10px 20px; font-size: 1em; background: #c94a4a;" onclick="deleteLog(${index})">Delete Log</button>`}
                </div>
                <div class="section-title">Log History</div>
                <div style="max-height: 200px; overflow-y: auto; padding-right: 15px; margin-bottom: 25px;">
                    ${log.data.statusLog.map(s => `
                        <div style="padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9em;">
                            <strong>${s.status}</strong> - ${s.date}
                        </div>
                    `).reverse().join('')}
                </div>
            `;

            // Data section
            htmlContent += `<div class="section-title">Data & Completion Details</div>`;
            htmlContent += `
                <div class="two-column">
                    <div class="input-group">
                        <label>Actual Days:</label>
                        <input type="text" id="editActualDays" value="${log.data.actualDays || ''}">
                    </div>
                    <div class="input-group">
                        <label>Completion Date:</label>
                        <input type="date" id="editCompletionDate" value="${log.data.completionDate ? formatDateForInput(log.data.completionDate) : ''}">
                    </div>
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Data Size (GB):</label>
                        <input type="text" id="editDataSize" value="${log.data.dataSize || ''}">
                    </div>
                    <div class="input-group">
                        <label>Analysis Time (Hours):</label>
                        <input type="text" id="editAnalysisTime" value="${log.data.analysisTime || ''}">
                    </div>
                </div>
                <button class="btn btn-tertiary" style="width: 100%;" onclick="saveDataDetails(${index})">Save Data Details</button>
            `;
            
            // Application Details section
            htmlContent += `<div class="section-title">${log.type} Application Details</div>`;
            htmlContent += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">`;
            
            const displayKeys = log.type === 'NXCT' ? [
                'appNumber', 'dateReceived', 'fullName', 'organisation', 'email', 'projectTitle', 'daysNeeded', 'equipment', 'numSamples', 'sampleComposition', 'scanningArea', 'status', 'dataDeleted'
            ] : [
                'internalNumber', 'title', 'lead', 'organisation', 'email', 'system', 'expectedDays', 'beamtime', 'notes', 'status', 'dataDeleted'
            ];

            const nxctKeyLabels = {
                appNumber: 'Application Number', dateReceived: 'Date Received', fullName: 'Full Name', organisation: 'Organisation', email: 'Email', projectTitle: 'Project Title', daysNeeded: 'Expected Days', equipment: 'Equipment Requested', numSamples: 'No. Samples', sampleComposition: 'Sample Comp.', scanningArea: 'Scanning Area', status: 'Status', dataDeleted: 'Data Deleted'
            };
            const internalKeyLabels = {
                internalNumber: 'Internal ID', title: 'Title', lead: 'Lead', organisation: 'Organisation', email: 'Email', system: 'System Used', expectedDays: 'Expected Days', beamtime: 'Beamtime Type', notes: 'Notes', status: 'Status', dataDeleted: 'Data Deleted'
            };
            const keyLabels = log.type === 'NXCT' ? nxctKeyLabels : internalKeyLabels;

            for (const key of Object.keys(log.data)) {
                if (!['statusLog', 'completionDate', 'actualDays', 'dataSize', 'analysisTime'].includes(key) && log.data[key]) {
                    const label = keyLabels[key] || key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    htmlContent += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong style="display: block; color: #555; font-size: 0.9em; margin-bottom: 4px;">${label}:</strong>
                            <span style="font-size: 1em;">${log.data[key]}</span>
                        </div>
                    `;
                }
            }
            htmlContent += `</div>`;


            document.getElementById('viewDetailsContent').innerHTML = htmlContent;
            document.getElementById('newStatus').value = log.data.status;
            document.getElementById('viewDetailsModal').classList.add('active');
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateStatus(index) {
            const log = experimentLogs[index];
            const newStatus = document.getElementById('newStatus').value;
            
            log.data.status = newStatus;
            log.data.statusLog.push({
                status: newStatus,
                date: new Date().toLocaleString()
            });

            renderLogs();
            viewDetails(index); // Re-render modal to show updated status log
            // alert(`Status for ${log.type} ${log.data.appNumber || log.data.internalNumber} updated to ${newStatus}.`);
        }

        function deleteLog(index) {
            if (confirm('Are you sure you want to mark this log as DELETED? This will hide it from active lists.')) {
                experimentLogs[index].data.dataDeleted = 'Yes';
                experimentLogs[index].data.statusLog.push({
                    status: 'Log Deleted (Soft Delete)',
                    date: new Date().toLocaleString()
                });
                renderLogs();
                closeModal('viewDetailsModal');
            }
        }

        function restoreLog(index) {
            if (confirm('Are you sure you want to RESTORE this log?')) {
                experimentLogs[index].data.dataDeleted = 'No';
                experimentLogs[index].data.statusLog.push({
                    status: 'Log Restored',
                    date: new Date().toLocaleString()
                });
                renderLogs();
                closeModal('viewDetailsModal');
            }
        }

        function saveDataDetails(index) {
            const log = experimentLogs[index];
            
            const actualDays = document.getElementById('editActualDays').value;
            const completionDate = document.getElementById('editCompletionDate').value;
            const dataSize = document.getElementById('editDataSize').value;
            const analysisTime = document.getElementById('editAnalysisTime').value;

            log.data.actualDays = actualDays.trim();
            log.data.completionDate = completionDate.trim();
            log.data.dataSize = dataSize.trim();
            log.data.analysisTime = analysisTime.trim();

            renderLogs();
            viewDetails(index); // Re-render modal
            // alert('Data and Completion details saved!');
        }

        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Convert sheet to JSON array, using the first row as headers
                const json = XLSX.utils.sheet_to_json(worksheet);
                
                const importedLogs = json.map(logData => {
                    const type = logData['Type'] === 'Internal' ? 'Internal' : 'NXCT';
                    
                    if (type === 'NXCT') {
                        const data = {
                            appNumber: String(logData['Application Number'] || ''),
                            dateReceived: String(logData['Date Received'] || ''),
                            fullName: String(logData['Full Name'] || ''),
                            organisation: String(logData['Organisation'] || ''),
                            email: String(logData['Email Address'] || ''),
                            projectTitle: String(logData['Project Title'] || ''),
                            projectDescription: String(logData['Project Description'] || ''),
                            subjectSector: String(logData['Primary Subject Sector'] || ''),
                            typeOfWork: String(logData['Type of Work'] || ''),
                            freeBeamtime: String(logData['Free Beamtime Access'] || ''),
                            daysNeeded: String(logData['Expected Days Needed'] || ''),
                            equipment: String(logData['Equipment Requested'] || ''),
                            previousExperience: String(logData['Previous XCT Experience'] || ''),
                            numSamples: String(logData['Number of Samples'] || ''),
                            sampleComposition: String(logData['Sample Composition'] || ''),
                            sampleDimensions: String(logData['Sample Shape and Dimensions'] || ''),
                            hazardous: String(logData['Hazardous Samples'] || ''),
                            samplesReady: String(logData['Samples Ready'] || ''),
                            readyDate: String(logData['Ready Date'] || ''),
                            featureSize: String(logData['Feature Size'] || ''),
                            scanningArea: String(logData['Scanning Area'] || ''),
                            analysisHelp: String(logData['Analysis Help Needed'] || ''),
                            analysisDetails: String(logData['Analysis Details'] || ''),
                            additionalNotes: String(logData['Additional Notes'] || ''),
                            
                            status: String(logData['Status'] || 'Acknowledged'),
                            completionDate: String(logData['Completion Date'] || ''),
                            actualDays: String(logData['Actual Days'] || ''),
                            dataSize: String(logData['Data Size'] || ''),
                            analysisTime: String(logData['Analysis Time'] || ''),
                            dataDeleted: String(logData['Data Deleted'] || 'No'),
                            statusLog: [{ status: String(logData['Status'] || 'Acknowledged'), date: new Date().toLocaleString() }]
                        };
                        return { type: 'NXCT', timestamp: new Date().toLocaleString(), data };
                    } else { // Internal Log
                        const data = {
                            internalNumber: String(logData['Internal Number'] || getNextInternalNumber()),
                            title: String(logData['Experiment Title'] || ''),
                            lead: String(logData['Experiment Lead'] || ''),
                            organisation: String(logData['Organisation'] || 'University College London'),
                            email: String(logData['Email Address'] || ''),
                            system: String(logData['System Used'] || ''),
                            expectedDays: String(logData['Expected Days'] || ''),
                            beamtime: String(logData['Beamtime'] || 'Free'),
                            notes: String(logData['Brief Experiment Description'] || ''),

                            status: String(logData['Status'] || 'Acknowledged'),
                            completionDate: String(logData['Completion Date'] || ''),
                            actualDays: String(logData['Actual Days'] || ''),
                            dataSize: String(logData['Data Size'] || ''),
                            analysisTime: String(logData['Analysis Time'] || ''),
                            dataDeleted: String(logData['Data Deleted'] || 'No'),
                            statusLog: [{ status: String(logData['Status'] || 'Acknowledged'), date: new Date().toLocaleString() }]
                        };
                        return { type: 'Internal', timestamp: new Date().toLocaleString(), data };
                    }
                });

                importLogs(importedLogs);
                // alert(`Successfully imported ${importedLogs.length} logs from Excel.`);
                document.getElementById('importExcelInput').value = ''; // Clear file input
            };
            reader.readAsArrayBuffer(file);
        }

        function importLogs(newLogs) {
            experimentLogs.unshift(...newLogs);
            renderLogs();
            initializeInternalCounter(); // Re-initialize counter based on all logs
        }
        
        function exportToExcel() {
            if (experimentLogs.length === 0) {
                alert('No data to export!');
                return;
            }

            const header = [
                "Type", "Application Number", "Date Received", "Full Name", "Organisation", "Email Address", 
                "Project Title", "Project Description", "Primary Subject Sector", "Type of Work", "Free Beamtime Access", 
                "Expected Days Needed", "Equipment Requested", "Previous XCT Experience", "Number of Samples", 
                "Sample Composition", "Sample Shape and Dimensions", "Hazardous Samples", "Samples Ready", 
                "Ready Date", "Feature Size", "Scanning Area", "Analysis Help Needed", "Analysis Details", 
                "Additional Notes", 
                "Internal Number", "Experiment Title", "Experiment Lead", "System Used", "Beamtime", "Expected Days", "Brief Experiment Description",
                "Status", "Completion Date", "Actual Days", "Data Size", "Analysis Time", "Data Deleted", "Logged On"
            ];

            const data = experimentLogs.map(log => {
                const row = new Array(header.length).fill('');
                
                row[0] = log.type;
                row[header.indexOf("Status")] = log.data.status;
                row[header.indexOf("Completion Date")] = log.data.completionDate;
                row[header.indexOf("Actual Days")] = log.data.actualDays;
                row[header.indexOf("Data Size")] = log.data.dataSize;
                row[header.indexOf("Analysis Time")] = log.data.analysisTime;
                row[header.indexOf("Data Deleted")] = log.data.dataDeleted;
                row[header.indexOf("Logged On")] = log.timestamp;

                if (log.type === 'NXCT') {
                    row[header.indexOf("Application Number")] = log.data.appNumber;
                    row[header.indexOf("Date Received")] = log.data.dateReceived;
                    row[header.indexOf("Full Name")] = log.data.fullName;
                    row[header.indexOf("Organisation")] = log.data.organisation;
                    row[header.indexOf("Email Address")] = log.data.email;
                    row[header.indexOf("Project Title")] = log.data.projectTitle;
                    row[header.indexOf("Project Description")] = log.data.projectDescription;
                    row[header.indexOf("Primary Subject Sector")] = log.data.subjectSector;
                    row[header.indexOf("Type of Work")] = log.data.typeOfWork;
                    row[header.indexOf("Free Beamtime Access")] = log.data.freeBeamtime;
                    row[header.indexOf("Expected Days Needed")] = log.data.daysNeeded;
                    row[header.indexOf("Equipment Requested")] = log.data.equipment;
                    row[header.indexOf("Previous XCT Experience")] = log.data.previousExperience;
                    row[header.indexOf("Number of Samples")] = log.data.numSamples;
                    row[header.indexOf("Sample Composition")] = log.data.sampleComposition;
                    row[header.indexOf("Sample Shape and Dimensions")] = log.data.sampleDimensions;
                    row[header.indexOf("Hazardous Samples")] = log.data.hazardous;
                    row[header.indexOf("Samples Ready")] = log.data.samplesReady;
                    row[header.indexOf("Ready Date")] = log.data.readyDate;
                    row[header.indexOf("Feature Size")] = log.data.featureSize;
                    row[header.indexOf("Scanning Area")] = log.data.scanningArea;
                    row[header.indexOf("Analysis Help Needed")] = log.data.analysisHelp;
                    row[header.indexOf("Analysis Details")] = log.data.analysisDetails;
                    row[header.indexOf("Additional Notes")] = log.data.additionalNotes;
                } else if (log.type === 'Internal') {
                    row[header.indexOf("Internal Number")] = log.data.internalNumber;
                    row[header.indexOf("Experiment Title")] = log.data.title;
                    row[header.indexOf("Experiment Lead")] = log.data.lead;
                    row[header.indexOf("Organisation")] = log.data.organisation;
                    row[header.indexOf("Email Address")] = log.data.email;
                    row[header.indexOf("System Used")] = log.data.system;
                    row[header.indexOf("Beamtime")] = log.data.beamtime;
                    row[header.indexOf("Expected Days")] = log.data.expectedDays;
                    row[header.indexOf("Brief Experiment Description")] = log.data.notes;
                }

                return row;
            });

            const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ExperimentLog");

            XLSX.writeFile(wb, "NXCT_Experiment_Log.xlsx");
        }

        function showAnalysis() {
            document.getElementById('analysisModal').classList.add('active');
            renderAnalysis();
        }

        function renderAnalysis() {
            const analysisContent = document.getElementById('analysisContent');
            if (!analysisContent) return; // Prevent errors if analysisModal is not open
            
            if (experimentLogs.length === 0) {
                analysisContent.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">No data to analyze yet. Please add or import logs.</p>';
                return;
            }

            const totalLogs = experimentLogs.length;
            const nxctCount = experimentLogs.filter(log => log.type === 'NXCT').length;
            const internalCount = totalLogs - nxctCount;
            
            // Status distribution
            const statusCounts = experimentLogs.reduce((acc, log) => {
                const status = log.data.status || 'Unknown';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            // Days/Duration analysis (simple sum for all logs)
            const totalExpectedDays = experimentLogs.reduce((sum, log) => {
                const days = log.type === 'NXCT' ? log.data.daysNeeded : log.data.expectedDays;
                return sum + (parseInt(days) || 0);
            }, 0);
            
            const totalActualDays = experimentLogs.reduce((sum, log) => {
                return sum + (parseInt(log.data.actualDays) || 0);
            }, 0);

            // Data size analysis (sum of all recorded data sizes)
            const totalDataSizeGB = experimentLogs.reduce((sum, log) => {
                return sum + (parseFloat(log.data.dataSize) || 0);
            }, 0).toFixed(2);
            
            const analysisHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #2c4a6e;">
                        <div style="font-size: 0.9em; color: #555;">Total Logs</div>
                        <div style="font-size: 2em; font-weight: 700; color: #2c4a6e;">${totalLogs}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #5d8a9e;">
                        <div style="font-size: 0.9em; color: #555;">Total Expected Days</div>
                        <div style="font-size: 2em; font-weight: 700; color: #5d8a9e;">${totalExpectedDays}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #4a7c59;">
                        <div style="font-size: 0.9em; color: #555;">Total Actual Days</div>
                        <div style="font-size: 2em; font-weight: 700; color: #4a7c59;">${totalActualDays}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #8e7a6d;">
                        <div style="font-size: 0.9em; color: #555;">Total Data Stored</div>
                        <div style="font-size: 2em; font-weight: 700; color: #8e7a6d;">${totalDataSizeGB} GB</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eee;">
                        <h3 style="color: #2c4a6e; margin-bottom: 20px;">Log Type Distribution</h3>
                        <canvas id="typeChart"></canvas>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eee;">
                        <h3 style="color: #2c4a6e; margin-bottom: 20px;">Status Breakdown</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            `;
            analysisContent.innerHTML = analysisHTML;

            // Chart 1: Type Distribution
            new Chart(document.getElementById('typeChart'), {
                type: 'pie',
                data: {
                    labels: ['NXCT Applications', 'Internal Applications'],
                    datasets: [{
                        data: [nxctCount, internalCount],
                        backgroundColor: ['#2c4a6e', '#5d7a9e'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });

            // Chart 2: Status Breakdown
            const statusLabels = Object.keys(statusCounts);
            const statusData = Object.values(statusCounts);
            const statusColors = statusLabels.map(label => {
                const statusClass = label.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const colors = {
                    'acknowledged': '#6d7a8a', 'samples-received': '#5d8a9e', 'scanning': '#c9a86a',
                    'scan-complete': '#b8856d', 'results-ready': '#4a7c59', 'data-transferred': '#7d6d9a',
                    'log-deleted-soft-delete': '#5a5a5a'
                };
                return colors[statusClass] || '#ccc';
            });

            new Chart(document.getElementById('statusChart'), {
                type: 'bar',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        label: 'Number of Logs',
                        data: statusData,
                        backgroundColor: statusColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function showMaintenance() {
            document.getElementById('maintenanceModal').classList.add('active');
            renderMaintenanceCalendar();
            renderMaintenanceList();
        }

        function renderMaintenanceCalendar() {
            const calendarEl = document.getElementById('maintenanceCalendar');
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            const month = currentCalendarMonth.getMonth();
            const year = currentCalendarMonth.getFullYear();
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = Sunday, 1 = Monday
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let calendarHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button class="close-btn" onclick="changeMonth(-1)">Previous</button>
                    <h4 style="margin: 0;">${monthNames[month]} ${year}</h4>
                    <button class="close-btn" onclick="changeMonth(1)">Next</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: #2c4a6e; margin-bottom: 5px;">
                    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;">
            `;

            // Adjust firstDayOfMonth to start on Monday (0 becomes 6, 1 becomes 0, etc.)
            let startDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

            // Blank padding for previous month
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const isoDate = currentDate.toISOString().split('T')[0];
                const isSelected = (selectedStartDate && isoDate === selectedStartDate.toISOString().split('T')[0]) ||
                                   (selectedEndDate && isoDate === selectedEndDate.toISOString().split('T')[0]);
                const isRange = selectedStartDate && selectedEndDate && currentDate > selectedStartDate && currentDate < selectedEndDate;
                
                const dayClass = isSelected ? 'selected-day' : (isRange ? 'range-day' : 'day');
                
                const maintenanceOnDay = maintenanceRecords.filter(record => {
                    const start = new Date(record.start);
                    const end = new Date(record.end);
                    // Ensure date comparison ignores time component for maintenance records
                    start.setHours(0, 0, 0, 0);
                    end.setHours(0, 0, 0, 0);
                    currentDate.setHours(0, 0, 0, 0);
                    return currentDate >= start && currentDate <= end;
                }).length > 0;

                const maintenanceClass = maintenanceOnDay ? 'maintenance-day' : '';
                
                const today = new Date();
                const isToday = currentDate.toDateString() === today.toDateString();

                calendarHTML += `
                    <div class="calendar-cell" style="padding: 5px;">
                        <div class="
                            ${dayClass} 
                            ${maintenanceClass} 
                            ${isToday ? 'today-day' : ''}
                            " 
                            onclick="selectDate(${year}, ${month}, ${day})"
                            style="
                                width: 30px; 
                                height: 30px; 
                                margin: 0 auto; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border-radius: 50%; 
                                cursor: pointer;
                                transition: all 0.2s;
                                font-size: 0.9em;
                                ${isToday ? 'border: 2px solid #2c4a6e;' : ''}
                                ${maintenanceOnDay ? 'background: #f8e8e8; color: #c94a4a; font-weight: 700;' : ''}
                                ${isRange ? 'background: #eef1f5;' : ''}
                                ${isSelected ? 'background: #2c4a6e; color: white; font-weight: 700;' : ''}
                            "
                        >${day}</div>
                    </div>
                `;
            }

            calendarHTML += '</div>';
            calendarEl.innerHTML = calendarHTML;
            updateDateRangeDisplay();
        }

        function changeMonth(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            renderMaintenanceCalendar();
        }

        function selectDate(year, month, day) {
            const date = new Date(year, month, day);
            if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                // Start new range
                selectedStartDate = date;
                selectedEndDate = null;
            } else if (date < selectedStartDate) {
                // Swap if new date is earlier than start
                selectedEndDate = selectedStartDate;
                selectedStartDate = date;
            } else {
                // Set end date
                selectedEndDate = date;
            }
            renderMaintenanceCalendar();
        }

        function updateDateRangeDisplay() {
            const display = document.getElementById('dateRangeDisplay');
            if (selectedStartDate && selectedEndDate) {
                const start = selectedStartDate.toLocaleDateString();
                const end = selectedEndDate.toLocaleDateString();
                display.textContent = `Selected Range: ${start} to ${end}`;
            } else if (selectedStartDate) {
                display.textContent = `Selected Start Date: ${selectedStartDate.toLocaleDateString()}`;
            } else {
                display.textContent = 'Click on calendar to select start date';
            }
        }
        
        function resetCalendar() {
            selectedStartDate = null;
            selectedEndDate = null;
            document.getElementById('maintenanceDescription').value = '';
            renderMaintenanceCalendar();
        }

        function addMaintenance() {
            const description = document.getElementById('maintenanceDescription').value.trim();

            if (!selectedStartDate || !description) {
                alert('Please select a date range and enter a description.');
                return;
            }

            const record = {
                start: selectedStartDate.toISOString().split('T')[0],
                end: selectedEndDate ? selectedEndDate.toISOString().split('T')[0] : selectedStartDate.toISOString().split('T')[0],
                description: description,
                addedOn: new Date().toLocaleDateString()
            };

            maintenanceRecords.push(record);
            maintenanceRecords.sort((a, b) => new Date(a.start) - new Date(b.start));

            resetCalendar();
            renderMaintenanceList();
            renderMaintenanceCalendar();
            localStorage.setItem('maintenanceRecords', JSON.stringify(maintenanceRecords));
            // alert('Maintenance added!');
        }

        function renderMaintenanceList() {
            const listEl = document.getElementById('maintenanceList');
            if (maintenanceRecords.length === 0) {
                listEl.innerHTML = '<p style="color: #666; font-style: italic;">No scheduled maintenance.</p>';
                return;
            }

            listEl.innerHTML = maintenanceRecords.map((record, index) => {
                const startDate = new Date(record.start).toLocaleDateString();
                const endDate = new Date(record.end).toLocaleDateString();
                const isPast = new Date(record.end) < new Date().setHours(0, 0, 0, 0);

                return `
                    <div style="background: ${isPast ? '#f0f0f0' : '#fff3e0'}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${isPast ? '#999' : '#c94a4a'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="color: ${isPast ? '#666' : '#c94a4a'};">${startDate} - ${endDate}</strong>
                                ${isPast ? '<span style="color: #999; margin-left: 10px; font-size: 0.9em;">(Past)</span>' : ''}
                            </div>
                            <button onclick="deleteMaintenance(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85em;">Delete</button>
                        </div>
                        <div style="color: #555;">${record.description}</div>
                        <div style="color: #999; font-size: 0.85em; margin-top: 8px;">Added: ${record.addedOn}</div>
                    </div>
                `;
            }).join('');
        }

        function deleteMaintenance(index) {
            if (confirm('Are you sure you want to permanently delete this maintenance record?')) {
                maintenanceRecords.splice(index, 1);
                localStorage.setItem('maintenanceRecords', JSON.stringify(maintenanceRecords));
                renderMaintenanceList();
                renderMaintenanceCalendar();
            }
        }
        
        function generateTestData() {
            const now = new Date().toLocaleDateString();
            const logs = [
                {
                    type: 'NXCT',
                    timestamp: now,
                    data: {
                        appNumber: 'NXCT001', dateReceived: now, fullName: 'Dr. Jane Doe', organisation: 'University of Sample',
                        email: 'jane.doe@sample.ac.uk', projectTitle: 'Analysis of Polymer Composites', projectDescription: 'Investigating void distribution...',
                        subjectSector: 'Materials Science', typeOfWork: 'Academic Research', freeBeamtime: 'Yes', daysNeeded: '5',
                        equipment: 'Microscope', previousExperience: 'Yes', numSamples: '10', sampleComposition: 'Polymer/Carbon Fiber',
                        sampleDimensions: '5x5x10mm', hazardous: 'No', samplesReady: 'Yes', readyDate: '2025-10-10',
                        featureSize: '5-10 microns', scanningArea: 'Whole sample', analysisHelp: 'No', analysisDetails: 'N/A',
                        additionalNotes: 'Urgent project.', status: 'Results Ready', completionDate: '2025-10-25', actualDays: '4', 
                        dataSize: '256', analysisTime: '12', dataDeleted: 'No',
                        statusLog: [{ status: 'Acknowledged', date: now }, { status: 'Results Ready', date: now }]
                    }
                },
                {
                    type: 'Internal',
                    timestamp: now,
                    data: {
                        internalNumber: getNextInternalNumber(), title: 'Detector Characterisation', lead: 'Dr. John Smith', organisation: 'UCL',
                        email: 'john.smith@ucl.ac.uk', system: 'Large Field of View', expectedDays: '2', beamtime: 'Free',
                        notes: 'Testing new filter set.', status: 'Scan Complete', completionDate: '', actualDays: '2', 
                        dataSize: '50', analysisTime: '5', dataDeleted: 'No',
                        statusLog: [{ status: 'Acknowledged', date: now }, { status: 'Scan Complete', date: now }]
                    }
                },
                {
                    type: 'NXCT',
                    timestamp: now,
                    data: {
                        appNumber: 'NXCT002', dateReceived: now, fullName: 'Prof. Max Power', organisation: 'Power Corp.',
                        email: 'max.p@powercorp.com', projectTitle: 'Turbine Blade Defect Inspection', projectDescription: 'Industrial QC check.',
                        subjectSector: 'Engineering', typeOfWork: 'Commercial', freeBeamtime: 'No', daysNeeded: '3',
                        equipment: 'Large Field of View', previousExperience: 'No', numSamples: '1', sampleComposition: 'Titanium Alloy',
                        sampleDimensions: '200mm length', hazardous: 'No', samplesReady: 'Yes', readyDate: '2025-11-01',
                        featureSize: '100 microns', scanningArea: 'Region of interest', analysisHelp: 'Yes', analysisDetails: 'Quantification of porosity.',
                        additionalNotes: 'Need results by end of month.', status: 'Scanning', completionDate: '', actualDays: '', 
                        dataSize: '', analysisTime: '', dataDeleted: 'No',
                        statusLog: [{ status: 'Acknowledged', date: now }, { status: 'Samples Received', date: now }, { status: 'Scanning', date: now }]
                    }
                },
                {
                    type: 'Internal',
                    timestamp: now,
                    data: {
                        internalNumber: getNextInternalNumber(), title: 'Micro-CT Calibration', lead: 'A. Tester', organisation: 'UCL',
                        email: 'a.tester@ucl.ac.uk', system: 'Microscope', expectedDays: '1', beamtime: 'Free',
                        notes: 'Standard monthly calibration.', status: 'Data Transferred', completionDate: '2025-10-05', actualDays: '1', 
                        dataSize: '10', analysisTime: '1', dataDeleted: 'Yes',
                        statusLog: [{ status: 'Acknowledged', date: now }, { status: 'Data Transferred', date: now }, { status: 'Log Deleted (Soft Delete)', date: now }]
                    }
                },
            ];

            experimentLogs.unshift(...logs);
            renderLogs();
            initializeInternalCounter();
        }

        // --- START NEW GOOGLE SHEET DATA CODE ---
        function showSheetImportModal() {
            document.getElementById('sheetIdInput').value = '';
            document.getElementById('sheetStatus').style.display = 'none';
            document.getElementById('sheetImportModal').classList.add('active');
        }
        
        function updateSheetStatus(message, type) {
            const statusDiv = document.getElementById('sheetStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message status-' + type;
            statusDiv.style.display = 'block';
        }

        function parseGoogleSheetResponse(data) {
            const sheetLogs = [];
            const rows = data.table.rows;
            const cols = data.table.cols;
            
            // Map column labels to the log data keys
            const keyMap = {
                'Application Number': 'appNumber',
                'Date Received': 'dateReceived',
                'Full Name': 'fullName',
                'Organisation': 'organisation',
                'Email Address': 'email',
                'Project Title': 'projectTitle',
                'Project Description': 'projectDescription',
                'Primary Subject Sector': 'subjectSector',
                'Type of Work': 'typeOfWork',
                'Free Beamtime Access': 'freeBeamtime',
                'Expected Days Needed': 'daysNeeded',
                'Equipment Requested': 'equipment',
                'Previous XCT Experience': 'previousExperience',
                'Number of Samples': 'numSamples',
                'Sample Composition': 'sampleComposition',
                'Sample Shape and Dimensions': 'sampleDimensions',
                'Hazardous Samples': 'hazardous',
                'Samples Ready': 'samplesReady',
                'Ready Date': 'readyDate',
                'Feature Size': 'featureSize',
                'Scanning Area': 'scanningArea',
                'Analysis Help Needed': 'analysisHelp',
                'Analysis Details': 'analysisDetails',
                'Additional Notes': 'additionalNotes',
                'Status': 'status',
                'Completion Date': 'completionDate',
                'Actual Days': 'actualDays',
                'Data Size': 'dataSize',
                'Analysis Time': 'analysisTime',
                'Data Deleted': 'dataDeleted',
                // Internal keys - assuming sheet contains combined data for simplicity
                'Internal Number': 'internalNumber',
                'Experiment Title': 'title',
                'Experiment Lead': 'lead',
                'System Used': 'system',
                'Beamtime': 'beamtime',
                'Expected Days': 'expectedDays',
                'Brief Experiment Description': 'notes',
                'Type': 'type' // Add Type to determine log type
            };

            const headerIndices = {};
            cols.forEach((col, index) => {
                const label = col.label.trim();
                if (keyMap[label]) {
                    headerIndices[keyMap[label]] = index;
                }
            });

            if (Object.keys(headerIndices).length < 5) { 
                throw new Error("Sheet headers not correctly mapped. Ensure the first row contains standard column names like 'Application Number' or 'Experiment Title'.");
            }

            rows.forEach((row) => {
                // Skip if row is empty or only contains null/empty cells (basic check)
                if (!row.c.some(c => c && (c.v !== null || c.f !== null))) {
                    return; 
                }
                
                const data = {};
                let type = 'NXCT';

                for (const key in headerIndices) {
                    const colIndex = headerIndices[key];
                    const cell = row.c[colIndex];
                    let value = cell && cell.v !== null ? cell.v : (cell && cell.f !== null ? cell.f : '');

                    // Handle date objects from Google Vis API
                    if (typeof value === 'object' && value.c) {
                        const dateArray = value.v; // [year, month-1, day, hour, minute, second]
                        value = new Date(dateArray[0], dateArray[1], dateArray[2]).toLocaleDateString();
                    }

                    if (typeof value === 'string') {
                        value = value.trim();
                    }
                    
                    if (key === 'type') {
                        type = value.toUpperCase().includes('INTERNAL') ? 'Internal' : 'NXCT';
                    } else if (key === 'status') {
                        data.status = value || 'Acknowledged';
                    } else if (key === 'dataDeleted') {
                        data.dataDeleted = value || 'No';
                    } else if (key === 'internalNumber' && type === 'Internal' && !value) {
                         // Assign a new internal number if empty and type is internal
                        data[key] = getNextInternalNumber();
                    } else {
                        data[key] = value;
                    }
                }
                
                // Final object construction
                const logData = {
                    type: type,
                    timestamp: new Date().toLocaleString(),
                    data: {
                        ...data,
                        status: data.status || 'Acknowledged',
                        dataDeleted: data.dataDeleted || 'No',
                        statusLog: [{ status: data.status || 'Acknowledged', date: new Date().toLocaleString() }]
                    }
                };

                // Ensure the log has a meaningful identifier before pushing
                if (logData.type === 'NXCT' && (logData.data.appNumber || logData.data.projectTitle)) {
                    sheetLogs.push(logData);
                } else if (logData.type === 'Internal' && (logData.data.internalNumber || logData.data.title)) {
                    sheetLogs.push(logData);
                }
            });

            return sheetLogs;
        }

        function importFromSheet() {
            const sheetId = document.getElementById('sheetIdInput').value.trim();
            if (!sheetId) {
                updateSheetStatus('Please enter a Google Sheet ID.', 'error');
                return;
            }

            updateSheetStatus('Fetching data from Google Sheet...', 'info');

            // Using the Google Visualization API to query all data (select *) from the first sheet (gid=0)
            const queryUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq=select%20*&gid=0`;

            fetch(queryUrl)
                .then(response => response.text())
                .then(dataText => {
                    // The Google API response is wrapped in a function call, e.g., google.visualization.Query.setResponse({...})
                    const match = dataText.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
                    if (!match) {
                        throw new Error("Invalid response format from Google Sheet API. Make sure the sheet is published to the web (File > Share > Publish to web).");
                    }
                    
                    const jsonText = match[1];
                    const data = JSON.parse(jsonText);

                    if (data.status === 'ok' && data.table) {
                        try {
                            const newLogs = parseGoogleSheetResponse(data);
                            importLogs(newLogs);
                            updateSheetStatus(`✓ Successfully imported ${newLogs.length} logs from the sheet!`, 'success');
                            setTimeout(() => closeModal('sheetImportModal'), 1500);
                        } catch (e) {
                            console.error("Sheet Parsing Error:", e);
                            updateSheetStatus(`Parsing Error: ${e.message}`, 'error');
                        }
                    } else {
                        updateSheetStatus(`Error fetching sheet data: ${data.errors ? data.errors[0].message : 'Unknown error'}. Check the Sheet ID and ensure "Anyone with the link" access is granted and it is published to the web.`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Network or Fetch Error:', error);
                    updateSheetStatus('Network error, invalid Sheet ID, or access permissions. Make sure the sheet is published and shared.', 'error');
                });
        }
        // --- END NEW GOOGLE SHEET DATA CODE ---


        // Load initial data from localStorage
        const storedLogs = localStorage.getItem('experimentLogs');
        if (storedLogs) {
            experimentLogs = JSON.parse(storedLogs);
        }
        
        const storedCounter = localStorage.getItem('internalCounter');
        if (storedCounter) {
            internalCounter = parseInt(storedCounter);
        }

        const storedMaintenance = localStorage.getItem('maintenanceRecords');
        if (storedMaintenance) {
            maintenanceRecords = JSON.parse(storedMaintenance);
        }

        const storedView = localStorage.getItem('compactView');
        if (storedView) {
            compactView = JSON.parse(storedView);
            if(document.getElementById('viewToggle')) {
                document.getElementById('viewToggle').classList.toggle('active', compactView);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            renderLogs();
            if(document.getElementById('viewToggle')) {
                document.getElementById('viewToggle').classList.toggle('active', compactView);
            }
        });
        
    </script>
</body>
</html>
