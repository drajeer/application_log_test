<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Log Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            background: #e8ecf1;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #000000;
            font-size: 2em;
            margin-bottom: 10px;
        }
        .main-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .btn {
            background: #2c4a6e;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            font-weight: 600;
        }
        .btn:hover {
            transform: translateY(-2px);
            background: #1c3a5e;
        }
        .btn-secondary {
            background: #8e7a6d;
        }
        .btn-secondary:hover {
            background: #7e6a5d;
        }
        .btn-tertiary {
            background: #5d7a9e;
        }
        .btn-tertiary:hover {
            background: #4d6a8e;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 20px;
        }
        .modal-content h2 {
            color: #2c4a6e;
            margin-bottom: 20px;
            text-align: center;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #2c4a6e;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .close-btn {
            background: #e0e0e0;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        .upload-zone {
            border: 3px dashed #5d7a9e;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f5f7f9;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        .upload-zone:hover {
            border-color: #2c4a6e;
            background: #eef1f5;
        }
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .section-title {
            color: #2c4a6e;
            font-size: 1.2em;
            margin: 25px 0 15px 0;
            font-weight: 600;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .log-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #5d7a9e;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .log-entry.status-acknowledged {
            border-left-color: #6d7a8a;
            background: #f5f7f9;
        }
        .log-entry.status-samples-received {
            border-left-color: #5d8a9e;
            background: #eff5f8;
        }
        .log-entry.status-scanning {
            border-left-color: #c9a86a;
            background: #f9f6ef;
        }
        .log-entry.status-scan-complete {
            border-left-color: #b8856d;
            background: #f8f3f0;
        }
        .log-entry.status-results-ready {
            border-left-color: #5d8a6d;
            background: #eff7f2;
        }
        .log-entry.status-data-transferred {
            border-left-color: #7d6d9a;
            background: #f4f1f7;
        }
        .log-entry:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .status-badge.acknowledged {
            background: #6d7a8a;
            color: white;
        }
        .status-badge.samples-received {
            background: #5d8a9e;
            color: white;
        }
        .status-badge.scanning {
            background: #c9a86a;
            color: white;
        }
        .status-badge.scan-complete {
            background: #b8856d;
            color: white;
        }
        .status-badge.results-ready {
            background: #5d8a6d;
            color: white;
        }
        .status-badge.data-transferred {
            background: #7d6d9a;
            color: white;
        }
        .log-entry h3 {
            color: #2c4a6e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .log-entry.deleted {
            background: #a0a0a0 !important;
            border-left-color: #5a5a5a !important;
            opacity: 0.5 !important;
        }
        .log-entry.deleted h3 {
            color: #5a5a5a !important;
        }
        .log-entry.deleted .status-badge {
            background: #7a7a7a !important;
        }
        .log-entry.deleted .log-detail {
            color: #888 !important;
        }
        .log-entry.deleted .log-detail strong {
            color: #777 !important;
        }
        .deleted-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 700;
            background: #5a5a5a;
            color: white;
            margin-right: 10px;
            text-transform: uppercase;
        }
        
        .data-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            gap: 5px;
        }
        .data-indicator.stored {
            background: #dfe5e9;
            color: #2c4a6e;
            border: 1px solid #c5d0d8;
        }
        .data-indicator.deleted {
            background: #e8d9da;
            color: #6d4a4b;
            border: 1px solid #d5c0c1;
        }
        .data-indicator.warning {
            background: #e9e3d5;
            color: #6d5f4a;
            border: 1px solid #d8ceb8;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .log-entry.compact {
            padding: 15px 20px;
        }
        .log-entry.compact h3 {
            margin-bottom: 0;
            display: inline;
            font-size: 1em;
        }
        .log-entry.compact .log-detail {
            display: none;
        }
        .log-entry.compact p {
            display: none;
        }
        .log-entry.compact .status-badge {
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #2c4a6e;
        }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }
        .toggle-label {
            font-weight: 600;
            color: #333;
        }
        .log-detail {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.95em;
        }
        .log-detail strong {
            color: #555;
        }
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 30px; flex-wrap: wrap;">
                <div style="flex: 0 0 120px;">
                    <div style="width: 120px; height: 80px; background: #e0e0e0; border: 2px dashed #999; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.85em; text-align: center; padding: 10px;">
                        Logo<br>Placeholder
                    </div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <h1>UCL NXCT Experiment Log</h1>
                </div>
                <div style="flex: 0 0 120px;">
                    <div style="width: 120px; height: 80px; background: #e0e0e0; border: 2px dashed #999; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.85em; text-align: center; padding: 10px;">
                        Logo<br>Placeholder
                    </div>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <button class="btn" onclick="showApplicationChoice()">+ New Application</button>
                <button class="btn btn-tertiary" onclick="exportToExcel()" style="background: #4a7c59;">üìä Export to Excel</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importExcelInput').click()" style="background: #8e7a6d;">üì• Import from Excel</button>
                <button class="btn" onclick="showAnalysis()" style="background: #5d8a9e;">üìà Analysis</button>
                <button class="btn" onclick="showMaintenance()" style="background: #c94a4a;">üîß Maintenance</button>
                <button class="btn" onclick="generateTestData()" style="background: #b8856d; font-size: 0.9em; padding: 12px 20px;">Generate Test Data</button>
                <input type="file" id="importExcelInput" accept=".xlsx, .xls" style="display: none;">
            </div>
            <div style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #333; margin: 0;">Application Log</h2>
                    <div class="view-toggle">
                        <span class="toggle-label">Compact View</span>
                        <div class="toggle-switch" id="viewToggle" onclick="toggleView()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                <div id="logsList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="applicationTypeModal">
        <div class="modal-content">
            <h2>Select Application Type</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Choose the type of application</p>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="selectNXCT()">NXCT</button>
                <button class="btn btn-tertiary" onclick="selectInternal()">Internal</button>
            </div>
            <button class="close-btn" onclick="closeModal('applicationTypeModal')" style="width: 100%; margin-top: 10px;">Cancel</button>
        </div>
    </div>

    <div class="modal" id="nxctModal">
        <div class="modal-content">
            <h2>NXCT Application</h2>
            <div class="upload-zone" onclick="document.getElementById('pdfInput').click()">
                <input type="file" id="pdfInput" accept=".pdf" multiple style="display: none;">
                <div style="font-size: 3em; margin-bottom: 15px;">üìÑ</div>
                <p style="font-size: 1.2em; font-weight: 600; color: #2c4a6e;">Upload NXCT Application PDF(s)</p>
                <p style="color: #666;">Click to browse or drag and drop (multiple files supported)</p>
            </div>
            <div id="uploadStatus" class="status-message"></div>
            <div id="extractedDataForm" style="display: none; position: relative; padding-bottom: 80px;">
                <div class="section-title">Application Details</div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Application Number:</label>
                        <input type="text" id="appNumber" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="input-group">
                        <label>Date Received:</label>
                        <input type="text" id="dateReceived" readonly style="background: #f5f5f5;">
                    </div>
                </div>
                <div class="section-title">Applicant Details</div>
                <div class="input-group">
                    <label>Full Name:</label>
                    <input type="text" id="fullName">
                </div>
                <div class="input-group">
                    <label>Organisation:</label>
                    <input type="text" id="organisation">
                </div>
                <div class="input-group">
                    <label>Email Address:</label>
                    <input type="text" id="email">
                </div>
                <div class="section-title">Project Details</div>
                <div class="input-group">
                    <label>Project Title:</label>
                    <input type="text" id="projectTitle">
                </div>
                <div class="input-group">
                    <label>Project Description:</label>
                    <textarea id="projectDescription" rows="6"></textarea>
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Primary Subject Sector:</label>
                        <input type="text" id="subjectSector">
                    </div>
                    <div class="input-group">
                        <label>Type of Work:</label>
                        <input type="text" id="typeOfWork">
                    </div>
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Free Beamtime Access:</label>
                        <input type="text" id="freeBeamtime">
                    </div>
                    <div class="input-group">
                        <label>Expected Days Needed:</label>
                        <input type="text" id="daysNeeded">
                    </div>
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Equipment Requested:</label>
                        <input type="text" id="equipment">
                    </div>
                    <div class="input-group">
                        <label>Previous XCT Experience:</label>
                        <input type="text" id="previousExperience">
                    </div>
                </div>
                <div class="section-title">Sample Details</div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Number of Samples:</label>
                        <input type="text" id="numSamples">
                    </div>
                    <div class="input-group">
                        <label>Sample Composition:</label>
                        <input type="text" id="sampleComposition">
                    </div>
                </div>
                <div class="input-group">
                    <label>Sample Shape and Dimensions:</label>
                    <input type="text" id="sampleDimensions">
                </div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Hazardous Samples:</label>
                        <input type="text" id="hazardous">
                    </div>
                    <div class="input-group">
                        <label>Samples Ready:</label>
                        <input type="text" id="samplesReady">
                    </div>
                </div>
                <div class="input-group">
                    <label>Ready Date:</label>
                    <input type="text" id="readyDate">
                </div>
                <div class="input-group">
                    <label>Feature Size:</label>
                    <textarea id="featureSize" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>Scanning Area:</label>
                    <input type="text" id="scanningArea">
                </div>
                <div class="input-group">
                    <label>Analysis Help Needed:</label>
                    <input type="text" id="analysisHelp">
                </div>
                <div class="input-group">
                    <label>Analysis Details:</label>
                    <textarea id="analysisDetails" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>Additional Notes:</label>
                    <textarea id="additionalNotes" rows="3"></textarea>
                </div>
                <div style="position: sticky; bottom: 0; right: 0; background: white; padding: 20px 0; margin-top: 20px; border-top: 2px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 15px;">
                    <button class="close-btn" onclick="closeModal('nxctModal')">Cancel</button>
                    <button class="btn" onclick="saveNXCTApplication()">Save Application</button>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal('nxctModal')" style="width: 100%;" id="cancelUploadBtn">Cancel</button>
        </div>
    </div>

    <div class="modal" id="internalModal">
        <div class="modal-content">
            <h2>Internal Application</h2>
            <div style="background: #e7f1ff; border: 2px solid #0d6efd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="margin: 0; color: #0d6efd; font-weight: 600;">Internal Number: <span id="internalNumberDisplay">Will be assigned on save</span></p>
            </div>
            
            <div class="input-group">
                <label>Experiment Title:</label>
                <input type="text" id="internalTitle" placeholder="Enter experiment title">
            </div>
            
            <div class="input-group">
                <label>Experiment Lead:</label>
                <input type="text" id="internalLead" placeholder="Enter name of experiment lead" required>
            </div>
            
            <div class="input-group">
                <label>Organisation:</label>
                <input type="text" id="internalOrganisation" value="University College London">
            </div>
            
            <div class="input-group">
                <label>Email Address:</label>
                <input type="email" id="internalEmail" placeholder="Enter email address" required>
            </div>
            
            <div class="input-group">
                <label>System Used:</label>
                <select id="internalSystem">
                    <option value="">Select system...</option>
                    <option value="Microscope">Microscope</option>
                    <option value="Large Field of View">Large Field of View</option>
                    <option value="Medium Field of View">Medium Field of View</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Expected Days:</label>
                <input type="number" id="internalDays" placeholder="Enter expected days" min="1">
            </div>
            
            <div class="input-group">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600; color: #333;">Free</span>
                    <div class="toggle-switch" id="beamtimeToggle" onclick="toggleBeamtime()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span style="font-weight: 600; color: #333;">Paid</span>
                </div>
            </div>
            
            <div class="input-group">
                <label>Brief Experiment Description:</label>
                <textarea id="internalNotes" placeholder="Brief description of the experiment" rows="4"></textarea>
            </div>
            
            <div class="button-group">
                <button class="btn" onclick="saveInternal()">Save</button>
                <button class="close-btn" onclick="closeModal('internalModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="viewDetailsModal">
        <div class="modal-content">
            <h2 id="viewDetailsTitle">Application Details</h2>
            <div id="viewDetailsContent"></div>
            <button class="close-btn" onclick="closeModal('viewDetailsModal')" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>

    <div class="modal" id="analysisModal">
        <div class="modal-content" style="max-width: 1100px;">
            <h2>Analysis Dashboard</h2>
            <div id="analysisContent"></div>
            <button class="close-btn" onclick="closeModal('analysisModal')" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>

    <div class="modal" id="maintenanceModal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>Maintenance Schedule</h2>
            
            <div style="margin-bottom: 30px;">
                <h3 style="color: #2c4a6e; margin-bottom: 15px;">Add New Maintenance</h3>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <strong id="dateRangeDisplay" style="color: #2c4a6e; font-size: 1.1em;">Click on calendar to select start date</strong>
                    </div>
                    <div id="maintenanceCalendar"></div>
                </div>
                
                <div class="input-group">
                    <label>Description:</label>
                    <textarea id="maintenanceDescription" rows="3" placeholder="Brief description of maintenance work"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="addMaintenance()" style="background: #c94a4a;">Add Maintenance</button>
                    <button class="btn" onclick="resetCalendar()" style="background: #8e7a6d;">Reset Dates</button>
                </div>
            </div>
            
            <div style="border-top: 2px solid #e0e0e0; padding-top: 20px;">
                <h3 style="color: #2c4a6e; margin-bottom: 15px;">Scheduled Maintenance</h3>
                <div id="maintenanceList"></div>
            </div>
            
            <button class="close-btn" onclick="closeModal('maintenanceModal')" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        let experimentLogs = [];
        let compactView = true;
        let internalCounter = 0;
        let maintenanceRecords = [];
        let selectedStartDate = null;
        let selectedEndDate = null;
        let currentCalendarMonth = new Date();

        function clearHighlightOnInput(field) {
            field.style.borderColor = '#e0e0e0';
            field.style.borderWidth = '2px';
            field.style.boxShadow = 'none';
        }

        function initializeInternalCounter() {
            let maxNum = 0;
            experimentLogs.forEach(log => {
                if (log.type === 'Internal' && log.data.internalNumber) {
                    const num = parseInt(log.data.internalNumber);
                    if (num > maxNum) maxNum = num;
                }
            });
            internalCounter = maxNum;
        }

        function getNextInternalNumber() {
            internalCounter++;
            return String(internalCounter).padStart(4, '0');
        }

        function showApplicationChoice() {
            document.getElementById('applicationTypeModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'nxctModal') {
                document.getElementById('pdfInput').value = '';
                document.getElementById('uploadStatus').style.display = 'none';
                document.getElementById('extractedDataForm').style.display = 'none';
                document.getElementById('cancelUploadBtn').style.display = 'block';
            }
            if (modalId === 'internalModal') {
                document.getElementById('internalNumberDisplay').textContent = 'Will be assigned on save';
            }
            if (modalId === 'analysisModal') {
                const analysisContent = document.getElementById('analysisContent');
                analysisContent.innerHTML = '';
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                const modals = document.querySelectorAll('.modal.active');
                modals.forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        function selectNXCT() {
            closeModal('applicationTypeModal');
            document.getElementById('nxctModal').classList.add('active');
        }

        function selectInternal() {
            closeModal('applicationTypeModal');
            
            const nextNumber = String(internalCounter + 1).padStart(4, '0');
            document.getElementById('internalNumberDisplay').textContent = nextNumber;
            
            document.getElementById('internalModal').classList.add('active');
        }

        document.getElementById('pdfInput').addEventListener('change', handlePDFUpload);
        document.getElementById('importExcelInput').addEventListener('change', handleExcelImport);

        async function handlePDFUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            showStatus(`Processing ${files.length} PDF file(s)...`, 'info');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    showStatus(`Processing ${i + 1} of ${files.length}: ${file.name}...`, 'info');
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    for (let j = 1; j <= pdf.numPages; j++) {
                        const page = await pdf.getPage(j);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    extractDataFromText(fullText);
                    successCount++;
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    errorCount++;
                }
            }
            
            if (errorCount === 0) {
                showStatus(`‚úì Successfully extracted data from ${successCount} PDF(s)! Review below and click Save.`, 'success');
            } else {
                showStatus(`‚ö† Extracted ${successCount} successfully, ${errorCount} failed.`, 'info');
            }
            
            document.getElementById('extractedDataForm').style.display = 'block';
            document.getElementById('cancelUploadBtn').style.display = 'none';
        }

        function extractDataFromText(text) {
            function cleanText(str) {
                if (!str) return '';
                str = str.replace(/\*/g, '').replace(/\?/g, '').replace(/\s+/g, ' ').trim();
                str = str.replace(/Applicant Details/gi, '');
                str = str.replace(/Project Details/gi, '');
                str = str.replace(/\(length x width x height\)/gi, '');
                str = str.replace(/for scanning\/shipped to the facility/gi, '');
                str = str.replace(/\(whole sample, region of interest, other\)/gi, '');
                return str.trim();
            }
            function extractBetween(text, startLabel, endLabel) {
                const start = startLabel.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const end = endLabel.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(start + '\\s*\\*?\\s*([\\s\\S]*?)(?=' + end + '|$)', 'i');
                const match = text.match(regex);
                return match ? cleanText(match[1]) : '';
            }
            
            document.getElementById('appNumber').value = extractBetween(text, 'APPLICATION NUMBER', 'DATE RECEIVED');
            document.getElementById('dateReceived').value = extractBetween(text, 'DATE RECEIVED', 'Full Name');
            document.getElementById('fullName').value = extractBetween(text, 'Full Name', 'Organisation');
            document.getElementById('organisation').value = extractBetween(text, 'Organisation', 'Email Address');
            document.getElementById('email').value = extractBetween(text, 'Email Address', 'Project Title');
            document.getElementById('projectTitle').value = extractBetween(text, 'Project Title', 'Project Description');
            
            let desc = extractBetween(text, 'Project Description', 'Primary Subject Sector');
            desc = desc.replace(/in\s+ammatory/g, 'inflammatory').replace(/e\s+cacy/g, 'efficacy').replace(/\s+rst/g, ' first');
            document.getElementById('projectDescription').value = desc;
            
            document.getElementById('subjectSector').value = extractBetween(text, 'Primary Subject Sector', 'Answer if');
            document.getElementById('typeOfWork').value = extractBetween(text, 'Type of Work', 'Applying for the NXCT Free Beamtime Access Scheme');
            document.getElementById('freeBeamtime').value = extractBetween(text, 'Applying for the NXCT Free Beamtime Access Scheme', 'If an SME');
            document.getElementById('daysNeeded').value = extractBetween(text, 'Expected number of days needed', 'Requested date of completion');
            
            let equipment = text.match(/Piece\s*\(\s*s\s*\)\s*of equipment requested[^*]*\*?\s*([^\n]+?)\s*NXCT facility equipment is based at/i);
            if (equipment) {
                document.getElementById('equipment').value = cleanText(equipment[1]);
            }
            
            document.getElementById('previousExperience').value = extractBetween(text, 'Any previous experience with X-ray Computed Tomography', 'If yes, details of previous experience');
            document.getElementById('numSamples').value = extractBetween(text, 'Number of samples', 'Sample shape and dimension');
            document.getElementById('sampleDimensions').value = extractBetween(text, 'Sample shape and dimension', 'Sample composition');
            document.getElementById('sampleComposition').value = extractBetween(text, 'Sample composition', 'Hazardous samples');
            document.getElementById('hazardous').value = extractBetween(text, 'Hazardous samples', 'If yes, details of hazardous samples');
            
            let scanArea = text.match(/Scanning area[^)]*\)\s*\*?\s*([^\n]+?)\s*Sample\s*\(\s*s\s*\)\s*ready/i);
            if (scanArea) {
                document.getElementById('scanningArea').value = cleanText(scanArea[1]);
            }
            
            let samplesReady = text.match(/Sample\s*\(\s*s\s*\)\s*ready\s*\*?\s*([^\n]+?)\s*Date when samples will be ready/i);
            if (samplesReady) {
                document.getElementById('samplesReady').value = cleanText(samplesReady[1]);
            }
            
            document.getElementById('readyDate').value = extractBetween(text, 'Date when samples will be ready', 'Size of feature');
            
            let featureSize = text.match(/Size of feature\s*\(\s*s\s*\)\s*\*?\s*([\s\S]+?)\s*In-situ or rig-only experiment/i);
            if (featureSize) {
                document.getElementById('featureSize').value = cleanText(featureSize[1]);
            }
            
            document.getElementById('analysisHelp').value = extractBetween(text, 'Analysis help needed', 'If yes or not sure, details of analysis help needed');
            document.getElementById('analysisDetails').value = extractBetween(text, 'If yes or not sure, details of analysis help needed', 'Details of any previous NXCT work');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message status-' + type;
            statusDiv.style.display = 'block';
        }

        function saveNXCTApplication() {
            const data = {
                appNumber: document.getElementById('appNumber').value,
                dateReceived: document.getElementById('dateReceived').value,
                fullName: document.getElementById('fullName').value,
                organisation: document.getElementById('organisation').value,
                email: document.getElementById('email').value,
                projectTitle: document.getElementById('projectTitle').value,
                projectDescription: document.getElementById('projectDescription').value,
                subjectSector: document.getElementById('subjectSector').value,
                typeOfWork: document.getElementById('typeOfWork').value,
                freeBeamtime: document.getElementById('freeBeamtime').value,
                daysNeeded: document.getElementById('daysNeeded').value,
                equipment: document.getElementById('equipment').value,
                previousExperience: document.getElementById('previousExperience').value,
                numSamples: document.getElementById('numSamples').value,
                sampleComposition: document.getElementById('sampleComposition').value,
                sampleDimensions: document.getElementById('sampleDimensions').value,
                hazardous: document.getElementById('hazardous').value,
                samplesReady: document.getElementById('samplesReady').value,
                readyDate: document.getElementById('readyDate').value,
                featureSize: document.getElementById('featureSize').value,
                scanningArea: document.getElementById('scanningArea').value,
                analysisHelp: document.getElementById('analysisHelp').value,
                analysisDetails: document.getElementById('analysisDetails').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                status: 'Acknowledged',
                completionDate: '',
                actualDays: '',
                dataSize: '',
                analysisTime: '',
                dataDeleted: 'No',
                statusLog: [{ status: 'Acknowledged', date: new Date().toLocaleString() }]
            };
            experimentLogs.unshift({ type: 'NXCT', timestamp: new Date().toLocaleString(), data });
            renderLogs();
            
            document.getElementById('pdfInput').value = '';
            document.getElementById('extractedDataForm').style.display = 'none';
            document.getElementById('cancelUploadBtn').style.display = 'block';
            
            closeModal('nxctModal');
            // // alert('NXCT Application saved successfully!');
        }

        function saveNXCTApplicationSilent() {
            const data = {
                appNumber: document.getElementById('appNumber').value,
                dateReceived: document.getElementById('dateReceived').value,
                fullName: document.getElementById('fullName').value,
                organisation: document.getElementById('organisation').value,
                email: document.getElementById('email').value,
                projectTitle: document.getElementById('projectTitle').value,
                projectDescription: document.getElementById('projectDescription').value,
                subjectSector: document.getElementById('subjectSector').value,
                typeOfWork: document.getElementById('typeOfWork').value,
                freeBeamtime: document.getElementById('freeBeamtime').value,
                daysNeeded: document.getElementById('daysNeeded').value,
                equipment: document.getElementById('equipment').value,
                previousExperience: document.getElementById('previousExperience').value,
                numSamples: document.getElementById('numSamples').value,
                sampleComposition: document.getElementById('sampleComposition').value,
                sampleDimensions: document.getElementById('sampleDimensions').value,
                hazardous: document.getElementById('hazardous').value,
                samplesReady: document.getElementById('samplesReady').value,
                readyDate: document.getElementById('readyDate').value,
                featureSize: document.getElementById('featureSize').value,
                scanningArea: document.getElementById('scanningArea').value,
                analysisHelp: document.getElementById('analysisHelp').value,
                analysisDetails: document.getElementById('analysisDetails').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                status: 'Acknowledged',
                completionDate: '',
                actualDays: '',
                dataSize: '',
                analysisTime: '',
                dataDeleted: 'No',
                statusLog: [{ status: 'Acknowledged', date: new Date().toLocaleString() }]
            };
            experimentLogs.unshift({ type: 'NXCT', timestamp: new Date().toLocaleString(), data });
            renderLogs();
        }

        function saveInternal() {
            const title = document.getElementById('internalTitle').value.trim();
            const lead = document.getElementById('internalLead').value.trim();
            const organisation = document.getElementById('internalOrganisation').value.trim();
            const email = document.getElementById('internalEmail').value.trim();
            const system = document.getElementById('internalSystem').value;
            const expectedDays = document.getElementById('internalDays').value;
            const beamtimeToggle = document.getElementById('beamtimeToggle');
            const beamtime = beamtimeToggle.classList.contains('active') ? 'Paid' : 'Free';
            const notes = document.getElementById('internalNotes').value.trim();
            
            if (!title) {
                // alert('Please enter a title');
                return;
            }
            
            if (!lead) {
                // alert('Please enter experiment lead name');
                return;
            }
            
            if (!email) {
                // alert('Please enter email address');
                return;
            }
            
            const internalNumber = getNextInternalNumber();
            const dateReceived = new Date().toLocaleDateString('en-GB');
            
            experimentLogs.unshift({ 
                type: 'Internal', 
                timestamp: new Date().toLocaleString(), 
                data: { 
                    internalNumber,
                    dateReceived,
                    title, 
                    lead,
                    organisation,
                    email,
                    system,
                    expectedDays,
                    beamtime,
                    notes,
                    completed: false,
                    completionDate: '',
                    daysUsed: ''
                } 
            });
            renderLogs();
            closeModal('internalModal');
            
            document.getElementById('internalTitle').value = '';
            document.getElementById('internalLead').value = '';
            document.getElementById('internalOrganisation').value = 'University College London';
            document.getElementById('internalEmail').value = '';
            document.getElementById('internalSystem').value = '';
            document.getElementById('internalDays').value = '';
            beamtimeToggle.classList.remove('active');
            document.getElementById('internalNotes').value = '';
            
            // // alert('Internal application saved successfully!');
        }

        function toggleView() {
            compactView = !compactView;
            const toggle = document.getElementById('viewToggle');
            if (compactView) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            renderLogs();
        }

        function toggleBeamtime() {
            const toggle = document.getElementById('beamtimeToggle');
            toggle.classList.toggle('active');
        }

        function getDataIndicator(data) {
            if (data.status !== 'Results Ready' && data.status !== 'Data Transferred') {
                return '';
            }

            const dataDeleted = data.dataDeleted === 'Yes';
            const completionDate = data.completionDate;

            if (dataDeleted) {
                return '<span class="data-indicator deleted">üóëÔ∏è Data Deleted</span>';
            }

            if (data.status === 'Data Transferred') {
                if (completionDate) {
                    const completed = new Date(completionDate);
                    const today = new Date();
                    const daysDiff = Math.floor((today - completed) / (1000 * 60 * 60 * 24));
                    const weeksPassed = Math.floor(daysDiff / 7);

                    if (weeksPassed >= 8) {
                        return `<span class="data-indicator warning">‚ö†Ô∏è Data stored - ${weeksPassed} weeks (Delete due!)</span>`;
                    }
                }
                return '<span class="data-indicator stored">üíæ Data Stored</span>';
            }

            return '<span class="data-indicator stored">üíæ Data Stored</span>';
        }

        function renderLogs() {
            const logsList = document.getElementById('logsList');
            if (experimentLogs.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #999;">No entries yet</p>';
                return;
            }
            logsList.innerHTML = experimentLogs.map((log, index) => {
                if (log.type === 'NXCT') {
                    const d = log.data;
                    const statusClass = getStatusClass(d.status || 'Acknowledged');
                    const statusBadgeClass = statusClass;
                    const dataIndicator = getDataIndicator(d);
                    const deletedClass = log.deleted ? 'deleted' : '';
                    const deletedBadge = log.deleted ? '<span class="deleted-badge">DELETED</span>' : '';
                    
                    if (compactView) {
                        return `<div class="log-entry compact status-${statusClass} ${deletedClass}" onclick="viewDetails(${index})">
                            ${deletedBadge}<span class="status-badge ${statusBadgeClass}">${d.status || 'Acknowledged'}</span>
                            <h3>${d.appNumber || 'N/A'} - ${d.projectTitle || 'No Title'} ${dataIndicator}</h3>
                        </div>`;
                    } else {
                        return `<div class="log-entry status-${statusClass} ${deletedClass}" onclick="viewDetails(${index})">
                            ${deletedBadge}<span class="status-badge ${statusBadgeClass}">${d.status || 'Acknowledged'}</span>
                            <h3>NXCT - ${d.appNumber || 'N/A'} ${dataIndicator}</h3>
                            <div class="log-detail"><strong>Date:</strong><span>${d.dateReceived}</span></div>
                            <div class="log-detail"><strong>Applicant:</strong><span>${d.fullName}</span></div>
                            <div class="log-detail"><strong>Organisation:</strong><span>${d.organisation}</span></div>
                            <div class="log-detail"><strong>Project:</strong><span>${d.projectTitle}</span></div>
                            <div class="log-detail"><strong>Equipment:</strong><span>${d.equipment}</span></div>
                            <div class="log-detail"><strong>Days Needed:</strong><span>${d.daysNeeded}</span></div>
                            <div class="log-detail"><strong>Logged:</strong><span>${log.timestamp}</span></div>
                            <p style="margin-top: 10px; color: #5d7a9e; font-size: 0.9em;">Click to view full details</p>
                        </div>`;
                    }
                } else {
                    const deletedClass = log.deleted ? 'deleted' : '';
                    const deletedBadge = log.deleted ? '<span class="deleted-badge">DELETED</span>' : '';
                    
                    if (compactView) {
                        return `<div class="log-entry compact ${deletedClass}" onclick="viewDetails(${index})">
                            ${deletedBadge}<h3>Internal-${log.data.internalNumber} - ${log.data.title}</h3>
                        </div>`;
                    } else {
                        return `<div class="log-entry ${deletedClass}" onclick="viewDetails(${index})">
                            ${deletedBadge}<h3>Internal - ${log.data.internalNumber}</h3>
                            <div class="log-detail"><strong>Title:</strong><span>${log.data.title}</span></div>
                            <div class="log-detail"><strong>Lead:</strong><span>${log.data.lead || 'N/A'}</span></div>
                            <div class="log-detail"><strong>System:</strong><span>${log.data.system || 'N/A'}</span></div>
                            <div class="log-detail"><strong>Expected Days:</strong><span>${log.data.expectedDays || 'N/A'}</span></div>
                            <div class="log-detail"><strong>Logged:</strong><span>${log.timestamp}</span></div>
                            <p style="margin-top: 10px; color: #667eea; font-size: 0.9em;">Click to view full details</p>
                        </div>`;
                    }
                }
            }).join('');
        }

        function viewDetails(index) {
            const log = experimentLogs[index];
            const modal = document.getElementById('viewDetailsModal');
            const title = document.getElementById('viewDetailsTitle');
            const content = document.getElementById('viewDetailsContent');

            if (log.type === 'NXCT') {
                const d = log.data;
                const deleteButtonText = log.deleted ? 'Restore Application' : 'Delete Application';
                const deleteButtonStyle = log.deleted ? 'background: #4a7c59;' : 'background: #c94a4a;';
                
                title.textContent = `NXCT Application - ${d.appNumber}`;
                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn" onclick="deleteApplication(${index})" style="padding: 10px 20px; font-size: 0.95em; ${deleteButtonStyle}">${deleteButtonText}</button>
                        <button class="btn" onclick="saveTracking(${index})" style="padding: 10px 20px; font-size: 0.95em;">Save Tracking Info</button>
                    </div>
                    
                    <div class="section-title">Project Status & Tracking</div>
                    <div class="input-group">
                        <label>Status:</label>
                        <input type="range" id="editStatusSlider" min="0" max="5" value="${getStatusValue(d.status)}" 
                               style="width: 100%;" oninput="updateStatusLabel(this.value)" onchange="validateStatusChange(this)">
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8em;">
                            <span style="color: #6d7a8a;">Acknowledged</span>
                            <span style="color: #5d8a9e;">Samples Received</span>
                            <span style="color: #c9a86a;">Scanning</span>
                            <span style="color: #b8856d;">Scan Complete</span>
                            <span style="color: #5d8a6d;">Results Ready</span>
                            <span style="color: #7d6d9a;">Data Transferred</span>
                        </div>
                        <div id="currentStatusLabel" style="text-align: center; margin-top: 10px; font-weight: 600; font-size: 1.1em;"></div>
                    </div>
                    <div class="two-column">
                        <div class="input-group">
                            <label>Data Transfer Date:</label>
                            <input type="date" id="editCompletionDate" value="${d.completionDate || ''}">
                        </div>
                        <div class="input-group">
                            <label>Days Used:</label>
                            <input type="number" id="editActualDays" value="${d.actualDays || ''}" placeholder="Required at Scan Complete" oninput="clearHighlightOnInput(this)">
                        </div>
                    </div>
                    
                    <div class="input-group" id="equipmentUsedGroup" style="${getStatusValue(d.status) >= 3 ? '' : 'display: none;'}">
                        <label style="margin-bottom: 10px;">Equipment Used (select at least one):</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="equipMicroscope" ${d.equipmentUsed && d.equipmentUsed.includes('Microscope') ? 'checked' : ''} 
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Microscope</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="equipLargeFOV" ${d.equipmentUsed && d.equipmentUsed.includes('Large Field of View') ? 'checked' : ''} 
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Large Field of View</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="equipMediumFOV" ${d.equipmentUsed && d.equipmentUsed.includes('Medium Field of View') ? 'checked' : ''} 
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Medium Field of View</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="equipOther" ${d.equipmentUsed && d.equipmentUsed.includes('Other') ? 'checked' : ''} 
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Other</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="two-column">
                        <div class="input-group">
                            <label>Data Size (GB):</label>
                            <input type="number" id="editDataSize" value="${d.dataSize || ''}" placeholder="Required at Results Ready" step="0.1" oninput="clearHighlightOnInput(this)">
                        </div>
                        <div class="input-group">
                            <label>Analysis Time (hours):</label>
                            <input type="number" id="editAnalysisTime" value="${d.analysisTime || ''}" placeholder="Required at Results Ready" step="0.5" oninput="clearHighlightOnInput(this)">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Data Deleted:</label>
                        <select id="editDataDeleted">
                            <option value="No" ${d.dataDeleted === 'No' ? 'selected' : ''}>No</option>
                            <option value="Yes" ${d.dataDeleted === 'Yes' ? 'selected' : ''}>Yes</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Status Change Log:</label>
                        <div style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; max-height: 150px; overflow-y: auto;">
                            ${d.statusLog && d.statusLog.length > 0 ? 
                                d.statusLog.map(entry => `<div style="padding: 5px 0; border-bottom: 1px solid #dee2e6; font-size: 0.9em;">
                                    <strong style="color: ${getStatusColor(entry.status)};">${entry.status}</strong> 
                                    <span style="color: #6c757d;">- ${entry.date}</span>
                                </div>`).join('') 
                                : '<div style="color: #999;">No status changes yet</div>'}
                        </div>
                    </div>

                    <div class="section-title">Application Details</div>
                    <div class="log-detail"><strong>Application Number:</strong><span>${d.appNumber || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Date Received:</strong><span>${d.dateReceived || 'N/A'}</span></div>
                    
                    <div class="section-title">Applicant Details</div>
                    <div class="log-detail"><strong>Full Name:</strong><span>${d.fullName || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Organisation:</strong><span>${d.organisation || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Email:</strong><span>${d.email || 'N/A'}</span></div>
                    
                    <div class="section-title">Project Details</div>
                    <div class="log-detail"><strong>Project Title:</strong><span>${d.projectTitle || 'N/A'}</span></div>
                    <div class="log-detail" style="grid-template-columns: 1fr;"><strong>Project Description:</strong><span style="white-space: pre-wrap;">${d.projectDescription || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Primary Subject Sector:</strong><span>${d.subjectSector || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Type of Work:</strong><span>${d.typeOfWork || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Free Beamtime Access:</strong><span>${d.freeBeamtime || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Expected Days Needed:</strong><span>${d.daysNeeded || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Equipment Requested:</strong><span>${d.equipment || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Previous XCT Experience:</strong><span>${d.previousExperience || 'N/A'}</span></div>
                    ${d.equipmentUsed ? `<div class="log-detail"><strong>Equipment Used:</strong><span>${d.equipmentUsed.join(', ')}</span></div>` : ''}
                    
                    <div class="section-title">Sample Details</div>
                    <div class="log-detail"><strong>Number of Samples:</strong><span>${d.numSamples || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Sample Composition:</strong><span>${d.sampleComposition || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Sample Dimensions:</strong><span>${d.sampleDimensions || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Hazardous Samples:</strong><span>${d.hazardous || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Samples Ready:</strong><span>${d.samplesReady || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Ready Date:</strong><span>${d.readyDate || 'N/A'}</span></div>
                    <div class="log-detail" style="grid-template-columns: 1fr;"><strong>Feature Size:</strong><span style="white-space: pre-wrap;">${d.featureSize || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Scanning Area:</strong><span>${d.scanningArea || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Analysis Help Needed:</strong><span>${d.analysisHelp || 'N/A'}</span></div>
                    <div class="log-detail" style="grid-template-columns: 1fr;"><strong>Analysis Details:</strong><span style="white-space: pre-wrap;">${d.analysisDetails || 'N/A'}</span></div>
                    ${d.additionalNotes ? `<div class="log-detail" style="grid-template-columns: 1fr;"><strong>Additional Notes:</strong><span style="white-space: pre-wrap;">${d.additionalNotes}</span></div>` : ''}
                    
                    <div class="log-detail" style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;"><strong>Logged:</strong><span>${log.timestamp}</span></div>
                `;
            } else {
                const deleteButtonText = log.deleted ? 'Restore Application' : 'Delete Application';
                const deleteButtonStyle = log.deleted ? 'background: #4a7c59;' : 'background: #c94a4a;';
                
                title.textContent = `Internal Application - ${log.data.internalNumber || 'N/A'}`;
                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn" onclick="deleteApplication(${index})" style="padding: 10px 20px; font-size: 0.95em; ${deleteButtonStyle}">${deleteButtonText}</button>
                        <button class="btn" onclick="saveInternalTracking(${index})" style="padding: 10px 20px; font-size: 0.95em;">Save Tracking Info</button>
                    </div>
                    
                    <div class="section-title">Tracking Information</div>
                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="internalCompleted" ${log.data.completed ? 'checked' : ''} 
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600;">Completed</span>
                        </label>
                    </div>
                    <div class="input-group" id="completionDateGroup" style="${log.data.completed ? '' : 'display: none;'}">
                        <label>Completion Date:</label>
                        <input type="date" id="internalCompletionDate" value="${log.data.completionDate || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="input-group">
                        <label>Days Used:</label>
                        <input type="number" id="internalDaysUsed" value="${log.data.daysUsed || ''}" 
                               placeholder="Enter days used" oninput="clearHighlightOnInput(this)">
                    </div>
                    
                    <div class="section-title">Application Details</div>
                    <div class="log-detail"><strong>Internal Number:</strong><span>${log.data.internalNumber || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Date Received:</strong><span>${log.data.dateReceived || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Experiment Title:</strong><span>${log.data.title}</span></div>
                    <div class="log-detail"><strong>Experiment Lead:</strong><span>${log.data.lead || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Organisation:</strong><span>${log.data.organisation || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Email Address:</strong><span>${log.data.email || 'N/A'}</span></div>
                    <div class="log-detail"><strong>System Used:</strong><span>${log.data.system || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Expected Days:</strong><span>${log.data.expectedDays || 'N/A'}</span></div>
                    <div class="log-detail"><strong>Free Beamtime Access:</strong><span>${log.data.beamtime || 'N/A'}</span></div>
                    ${log.data.notes ? `<div class="log-detail" style="grid-template-columns: 1fr;"><strong>Brief Experiment Description:</strong><span style="white-space: pre-wrap;">${log.data.notes}</span></div>` : ''}
                    <div class="log-detail" style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;"><strong>Logged:</strong><span>${log.timestamp}</span></div>
                `;
                
                setTimeout(() => {
                    const checkbox = document.getElementById('internalCompleted');
                    const dateGroup = document.getElementById('completionDateGroup');
                    const dateInput = document.getElementById('internalCompletionDate');
                    const daysUsedInput = document.getElementById('internalDaysUsed');
                    
                    if (checkbox) {
                        checkbox.addEventListener('change', function() {
                            if (this.checked) {
                                dateGroup.style.display = 'block';
                                if (!dateInput.value) {
                                    dateInput.value = new Date().toISOString().split('T')[0];
                                }
                                if (daysUsedInput && !daysUsedInput.value.trim()) {
                                    daysUsedInput.style.borderColor = '#fd7e14';
                                    daysUsedInput.style.borderWidth = '3px';
                                    daysUsedInput.style.boxShadow = '0 0 10px rgba(253, 126, 20, 0.4)';
                                }
                            } else {
                                dateGroup.style.display = 'none';
                                if (daysUsedInput) {
                                    daysUsedInput.style.borderColor = '#e0e0e0';
                                    daysUsedInput.style.borderWidth = '2px';
                                    daysUsedInput.style.boxShadow = 'none';
                                }
                            }
                        });
                    }
                }, 100);
            }

            modal.classList.add('active');
            modal.setAttribute('data-current-index', index);
            
            if (log.type === 'NXCT') {
                updateStatusLabel(getStatusValue(log.data.status));
                const slider = document.getElementById('editStatusSlider');
                if (slider) {
                    slider.setAttribute('data-last-valid', slider.value);
                }
            }
        }

        function validateStatusChange(slider) {
            const newValue = parseInt(slider.value);
            const lastValid = parseInt(slider.getAttribute('data-last-valid') || '0');
            const newStatus = getStatusFromValue(newValue);
            
            const daysField = document.getElementById('editActualDays');
            const dataSizeField = document.getElementById('editDataSize');
            const analysisTimeField = document.getElementById('editAnalysisTime');
            const equipmentGroup = document.getElementById('equipmentUsedGroup');
            
            if (newValue >= 3 && equipmentGroup) {
                equipmentGroup.style.display = 'block';
            } else if (equipmentGroup) {
                equipmentGroup.style.display = 'none';
            }
            
            if (newValue === 3) {
                if (daysField && !daysField.value.trim()) {
                    daysField.style.borderColor = '#fd7e14';
                    daysField.style.borderWidth = '4px';
                    daysField.style.boxShadow = '0 0 15px rgba(253, 126, 20, 0.6)';
                }
                
                const microscope = document.getElementById('equipMicroscope')?.checked;
                const largeFOV = document.getElementById('equipLargeFOV')?.checked;
                const mediumFOV = document.getElementById('equipMediumFOV')?.checked;
                const other = document.getElementById('equipOther')?.checked;
                
                if (!microscope && !largeFOV && !mediumFOV && !other && equipmentGroup) {
                    equipmentGroup.style.borderColor = '#fd7e14';
                    equipmentGroup.style.borderWidth = '3px';
                    equipmentGroup.style.borderStyle = 'solid';
                    equipmentGroup.style.borderRadius = '8px';
                    equipmentGroup.style.padding = '15px';
                    equipmentGroup.style.boxShadow = '0 0 15px rgba(253, 126, 20, 0.6)';
                }
            }
            
            if (newValue > 3) {
                if (!daysField || !daysField.value.trim()) {
                    // alert('‚ö†Ô∏è Days Used is required before moving past Scan Complete!');
                    slider.value = Math.min(lastValid, 3);
                    updateStatusLabel(slider.value);
                    if (daysField) {
                        daysField.style.borderColor = '#dc3545';
                        daysField.style.borderWidth = '4px';
                        daysField.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.6)';
                        daysField.focus();
                    }
                    return;
                }
                
                const microscope = document.getElementById('equipMicroscope')?.checked;
                const largeFOV = document.getElementById('equipLargeFOV')?.checked;
                const mediumFOV = document.getElementById('equipMediumFOV')?.checked;
                const other = document.getElementById('equipOther')?.checked;
                
                if (!microscope && !largeFOV && !mediumFOV && !other) {
                    // alert('‚ö†Ô∏è Please select at least one equipment type used before moving past Scan Complete!');
                    slider.value = Math.min(lastValid, 3);
                    updateStatusLabel(slider.value);
                    if (equipmentGroup) {
                        equipmentGroup.style.borderColor = '#dc3545';
                        equipmentGroup.style.borderWidth = '3px';
                        equipmentGroup.style.borderStyle = 'solid';
                        equipmentGroup.style.borderRadius = '8px';
                        equipmentGroup.style.padding = '15px';
                        equipmentGroup.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.6)';
                    }
                    return;
                }
            }
            
            if (newValue === 4) {
                let missingFields = [];
                
                if (!dataSizeField || !dataSizeField.value.trim()) {
                    missingFields.push('Data Size (GB)');
                    if (dataSizeField) {
                        dataSizeField.style.borderColor = '#fd7e14';
                        dataSizeField.style.borderWidth = '4px';
                        dataSizeField.style.boxShadow = '0 0 15px rgba(253, 126, 20, 0.6)';
                    }
                }
                
                if (!analysisTimeField || !analysisTimeField.value.trim()) {
                    missingFields.push('Analysis Time (hours)');
                    if (analysisTimeField) {
                        analysisTimeField.style.borderColor = '#fd7e14';
                        analysisTimeField.style.borderWidth = '4px';
                        analysisTimeField.style.boxShadow = '0 0 15px rgba(253, 126, 20, 0.6)';
                    }
                }
                
                if (missingFields.length > 0) {
                    if (dataSizeField && !dataSizeField.value.trim()) {
                        dataSizeField.focus();
                    } else if (analysisTimeField && !analysisTimeField.value.trim()) {
                        analysisTimeField.focus();
                    }
                }
            }
            
            if (newValue === 5) {
                const completionDateField = document.getElementById('editCompletionDate');
                if (completionDateField && !completionDateField.value) {
                    const today = new Date().toISOString().split('T')[0];
                    completionDateField.value = today;
                }
            }
            
            if (newValue > 4) {
                let missingFields = [];
                
                if (!dataSizeField || !dataSizeField.value.trim()) {
                    missingFields.push('Data Size (GB)');
                    if (dataSizeField) {
                        dataSizeField.style.borderColor = '#dc3545';
                        dataSizeField.style.borderWidth = '4px';
                        dataSizeField.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.6)';
                    }
                }
                
                if (!analysisTimeField || !analysisTimeField.value.trim()) {
                    missingFields.push('Analysis Time (hours)');
                    if (analysisTimeField) {
                        analysisTimeField.style.borderColor = '#dc3545';
                        analysisTimeField.style.borderWidth = '4px';
                        analysisTimeField.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.6)';
                    }
                }
                
                if (missingFields.length > 0) {
                    // alert('‚ö†Ô∏è ' + missingFields.join(' and ') + ' required before moving to Data Transferred!');
                    slider.value = Math.min(lastValid, 4);
                    updateStatusLabel(slider.value);
                    
                    if (dataSizeField && !dataSizeField.value.trim()) {
                        dataSizeField.focus();
                    } else if (analysisTimeField && !analysisTimeField.value.trim()) {
                        analysisTimeField.focus();
                    }
                    return;
                }
            }
            
            slider.setAttribute('data-last-valid', newValue);
        }

        function getStatusValue(status) {
            const statusMap = {
                'Acknowledged': 0,
                'Samples Received': 1,
                'Scanning': 2,
                'Scan Complete': 3,
                'Results Ready': 4,
                'Data Transferred': 5
            };
            return statusMap[status] || 0;
        }

        function getStatusFromValue(value) {
            const statuses = ['Acknowledged', 'Samples Received', 'Scanning', 'Scan Complete', 'Results Ready', 'Data Transferred'];
            return statuses[parseInt(value)] || 'Acknowledged';
        }

        function getStatusClass(status) {
            return status.toLowerCase().replace(/ /g, '-');
        }

        function updateStatusLabel(value) {
            const status = getStatusFromValue(value);
            const label = document.getElementById('currentStatusLabel');
            const statusClass = getStatusClass(status);
            const colors = {
                'acknowledged': '#6d7a8a',
                'samples-received': '#5d8a9e',
                'scanning': '#c9a86a',
                'scan-complete': '#b8856d',
                'results-ready': '#5d8a6d',
                'data-transferred': '#7d6d9a'
            };
            if (label) {
                label.textContent = status;
                label.style.color = colors[statusClass];
            }
        }

        function getStatusColor(status) {
            const colors = {
                'Acknowledged': '#6d7a8a',
                'Samples Received': '#5d8a9e',
                'Scanning': '#c9a86a',
                'Scan Complete': '#b8856d',
                'Results Ready': '#5d8a6d',
                'Data Transferred': '#7d6d9a'
            };
            return colors[status] || '#6d7a8a';
        }

        function saveTracking(index) {
            const log = experimentLogs[index];
            if (log.type === 'NXCT') {
                const statusValue = document.getElementById('editStatusSlider').value;
                const newStatus = getStatusFromValue(statusValue);
                const oldStatus = log.data.status;
                
                const daysUsed = document.getElementById('editActualDays').value.trim();
                const dataSize = document.getElementById('editDataSize').value.trim();
                const analysisTime = document.getElementById('editAnalysisTime').value.trim();
                
                const scanCompleteIndex = ['Acknowledged', 'Samples Received', 'Scanning', 'Scan Complete', 'Results Ready', 'Data Transferred'].indexOf('Scan Complete');
                const currentStatusIndex = ['Acknowledged', 'Samples Received', 'Scanning', 'Scan Complete', 'Results Ready', 'Data Transferred'].indexOf(newStatus);
                
                if (currentStatusIndex >= scanCompleteIndex && !daysUsed) {
                    // alert('Days Used is required when status is Scan Complete or later!');
                    document.getElementById('editActualDays').style.borderColor = '#dc3545';
                    document.getElementById('editActualDays').style.borderWidth = '3px';
                    document.getElementById('editActualDays').focus();
                    return;
                }
                
                if (currentStatusIndex >= scanCompleteIndex) {
                    const microscope = document.getElementById('equipMicroscope')?.checked;
                    const largeFOV = document.getElementById('equipLargeFOV')?.checked;
                    const mediumFOV = document.getElementById('equipMediumFOV')?.checked;
                    const other = document.getElementById('equipOther')?.checked;
                    
                    if (!microscope && !largeFOV && !mediumFOV && !other) {
                        // alert('Please select at least one equipment type used!');
                        return;
                    }
                    
                    const equipmentUsed = [];
                    if (microscope) equipmentUsed.push('Microscope');
                    if (largeFOV) equipmentUsed.push('Large Field of View');
                    if (mediumFOV) equipmentUsed.push('Medium Field of View');
                    if (other) equipmentUsed.push('Other');
                    
                    log.data.equipmentUsed = equipmentUsed;
                }
                
                const resultsReadyIndex = ['Acknowledged', 'Samples Received', 'Scanning', 'Scan Complete', 'Results Ready', 'Data Transferred'].indexOf('Results Ready');
                
                if (currentStatusIndex >= resultsReadyIndex) {
                    if (!dataSize) {
                        // alert('Data Size (GB) is required when status is Results Ready or later!');
                        document.getElementById('editDataSize').style.borderColor = '#dc3545';
                        document.getElementById('editDataSize').style.borderWidth = '3px';
                        document.getElementById('editDataSize').focus();
                        return;
                    }
                    if (!analysisTime) {
                        // alert('Analysis Time (hours) is required when status is Results Ready or later!');
                        document.getElementById('editAnalysisTime').style.borderColor = '#dc3545';
                        document.getElementById('editAnalysisTime').style.borderWidth = '3px';
                        document.getElementById('editAnalysisTime').focus();
                        return;
                    }
                }
                
                if (!log.data.statusLog) {
                    log.data.statusLog = [{ status: oldStatus || 'Acknowledged', date: log.timestamp }];
                }
                
                if (newStatus !== oldStatus) {
                    log.data.statusLog.push({
                        status: newStatus,
                        date: new Date().toLocaleString()
                    });
                }
                
                log.data.status = newStatus;
                log.data.completionDate = document.getElementById('editCompletionDate').value;
                log.data.actualDays = daysUsed;
                log.data.dataSize = dataSize;
                log.data.analysisTime = analysisTime;
                log.data.dataDeleted = document.getElementById('editDataDeleted').value;
                
                renderLogs();
                closeModal('viewDetailsModal');
                // // alert('Tracking information saved successfully!');
            }
        }

        function saveInternalTracking(index) {
            const log = experimentLogs[index];
            if (log.type === 'Internal') {
                const completed = document.getElementById('internalCompleted').checked;
                const completionDate = document.getElementById('internalCompletionDate') ? document.getElementById('internalCompletionDate').value : '';
                const daysUsed = document.getElementById('internalDaysUsed').value.trim();
                
                if (completed && !daysUsed) {
                    // alert('‚ö†Ô∏è Days Used is required when marking as Completed!');
                    const daysField = document.getElementById('internalDaysUsed');
                    daysField.style.borderColor = '#dc3545';
                    daysField.style.borderWidth = '4px';
                    daysField.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.6)';
                    daysField.focus();
                    return;
                }
                
                log.data.completed = completed;
                log.data.completionDate = completionDate;
                log.data.daysUsed = daysUsed;
                
                renderLogs();
                closeModal('viewDetailsModal');
                // alert('Tracking information saved successfully!');
            }
        }

        function deleteApplication(index) {
            const log = experimentLogs[index];
            
            if (!log) {
                // alert('Error: Application not found');
                return;
            }
            
            log.deleted = !log.deleted;
            
            renderLogs();
            closeModal('viewDetailsModal');
            
            const action = log.deleted ? 'marked as DELETED' : 'RESTORED';
            // alert(`Application ${action}!`);
        }

        function exportToExcel() {
            if (experimentLogs.length === 0) {
                // alert('No data to export. Please add some applications first.');
                return;
            }

            const excelData = [];
            
            experimentLogs.forEach(log => {
                if (log.type === 'NXCT') {
                    const d = log.data;
                    excelData.push({
                        'Type': 'NXCT',
                        'Deleted': log.deleted ? 'Yes' : 'No',
                        'Application Number': d.appNumber || '',
                        'Date Received': d.dateReceived || '',
                        'Full Name': d.fullName || '',
                        'Organisation': d.organisation || '',
                        'Email': d.email || '',
                        'Project Title': d.projectTitle || '',
                        'Project Description': d.projectDescription || '',
                        'Primary Subject Sector': d.subjectSector || '',
                        'Type of Work': d.typeOfWork || '',
                        'Free Beamtime Access': d.freeBeamtime || '',
                        'Expected Days Needed': d.daysNeeded || '',
                        'Equipment Requested': d.equipment || '',
                        'Previous XCT Experience': d.previousExperience || '',
                        'Equipment Used': d.equipmentUsed ? d.equipmentUsed.join(', ') : '',
                        'Number of Samples': d.numSamples || '',
                        'Sample Composition': d.sampleComposition || '',
                        'Sample Dimensions': d.sampleDimensions || '',
                        'Hazardous Samples': d.hazardous || '',
                        'Samples Ready': d.samplesReady || '',
                        'Ready Date': d.readyDate || '',
                        'Feature Size': d.featureSize || '',
                        'Scanning Area': d.scanningArea || '',
                        'Analysis Help Needed': d.analysisHelp || '',
                        'Analysis Details': d.analysisDetails || '',
                        'Additional Notes': d.additionalNotes || '',
                        'Status': d.status || 'Acknowledged',
                        'Completion Date': d.completionDate || '',
                        'Days Used': d.actualDays || '',
                        'Data Size (GB)': d.dataSize || '',
                        'Analysis Time (hours)': d.analysisTime || '',
                        'Data Deleted': d.dataDeleted || 'No',
                        'Status Log': d.statusLog ? JSON.stringify(d.statusLog) : '',
                        'Logged At': log.timestamp
                    });
                } else {
                    excelData.push({
                        'Type': 'Internal',
                        'Deleted': log.deleted ? 'Yes' : 'No',
                        'Application Number': log.data.internalNumber || '',
                        'Date Received': log.data.dateReceived || '',
                        'Full Name': log.data.lead || '',
                        'Organisation': log.data.organisation || '',
                        'Email': log.data.email || '',
                        'Project Title': log.data.title || '',
                        'Project Description': log.data.notes || '',
                        'Primary Subject Sector': '',
                        'Type of Work': 'Internal',
                        'Free Beamtime Access': log.data.beamtime || '',
                        'Expected Days Needed': log.data.expectedDays || '',
                        'Equipment Requested': log.data.system || '',
                        'Previous XCT Experience': '',
                        'Number of Samples': '',
                        'Sample Composition': '',
                        'Sample Dimensions': '',
                        'Hazardous Samples': '',
                        'Samples Ready': '',
                        'Ready Date': '',
                        'Feature Size': '',
                        'Scanning Area': '',
                        'Analysis Help Needed': '',
                        'Analysis Details': '',
                        'Additional Notes': '',
                        'Status': log.data.completed ? 'Completed' : 'In Progress',
                        'Completion Date': log.data.completionDate || '',
                        'Days Used': log.data.daysUsed || '',
                        'Data Size (GB)': '',
                        'Analysis Time (hours)': '',
                        'Data Deleted': '',
                        'Status Log': '',
                        'Logged At': log.timestamp
                    });
                }
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            const colWidths = [
                { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 30 }, { wch: 30 },
                { wch: 40 }, { wch: 60 }, { wch: 20 }, { wch: 20 }, { wch: 25 }, { wch: 15 },
                { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 30 }, { wch: 15 },
                { wch: 15 }, { wch: 15 }, { wch: 40 }, { wch: 20 }, { wch: 20 }, { wch: 50 },
                { wch: 40 }, { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 18 },
                { wch: 15 }, { wch: 40 }, { wch: 20 }
            ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, 'Experiment Logs');

            const date = new Date().toISOString().split('T')[0];
            const filename = `Experiment_Logs_${date}.xlsx`;

            XLSX.writeFile(wb, filename);
        }

        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        // alert('No data found in Excel file');
                        return;
                    }

                    const importedLogs = jsonData.map(row => {
                        if (row.Type === 'NXCT') {
                            return {
                                type: 'NXCT',
                                deleted: row.Deleted === 'Yes',
                                timestamp: row['Logged At'] || new Date().toLocaleString(),
                                data: {
                                    appNumber: row['Application Number'] || '',
                                    dateReceived: row['Date Received'] || '',
                                    fullName: row['Full Name'] || '',
                                    organisation: row['Organisation'] || '',
                                    email: row['Email'] || '',
                                    projectTitle: row['Project Title'] || '',
                                    projectDescription: row['Project Description'] || '',
                                    subjectSector: row['Primary Subject Sector'] || '',
                                    typeOfWork: row['Type of Work'] || '',
                                    freeBeamtime: row['Free Beamtime Access'] || '',
                                    daysNeeded: row['Expected Days Needed'] || '',
                                    equipment: row['Equipment Requested'] || '',
                                    previousExperience: row['Previous XCT Experience'] || '',
                                    equipmentUsed: row['Equipment Used'] ? row['Equipment Used'].split(', ').filter(e => e) : [],
                                    numSamples: row['Number of Samples'] || '',
                                    sampleComposition: row['Sample Composition'] || '',
                                    sampleDimensions: row['Sample Dimensions'] || '',
                                    hazardous: row['Hazardous Samples'] || '',
                                    samplesReady: row['Samples Ready'] || '',
                                    readyDate: row['Ready Date'] || '',
                                    featureSize: row['Feature Size'] || '',
                                    scanningArea: row['Scanning Area'] || '',
                                    analysisHelp: row['Analysis Help Needed'] || '',
                                    analysisDetails: row['Analysis Details'] || '',
                                    additionalNotes: row['Additional Notes'] || '',
                                    status: row['Status'] || 'Acknowledged',
                                    completionDate: row['Completion Date'] || '',
                                    actualDays: row['Days Used'] || '',
                                    dataSize: row['Data Size (GB)'] || '',
                                    analysisTime: row['Analysis Time (hours)'] || '',
                                    dataDeleted: row['Data Deleted'] || 'No',
                                    statusLog: row['Status Log'] ? JSON.parse(row['Status Log']) : [{ status: row['Status'] || 'Acknowledged', date: row['Logged At'] }]
                                }
                            };
                        } else if (row.Type === 'Internal') {
                            return {
                                type: 'Internal',
                                deleted: row.Deleted === 'Yes',
                                timestamp: row['Logged At'] || new Date().toLocaleString(),
                                data: {
                                    internalNumber: row['Application Number'] || '',
                                    dateReceived: row['Date Received'] || '',
                                    title: row['Project Title'] || '',
                                    lead: row['Full Name'] || '',
                                    organisation: row['Organisation'] || '',
                                    email: row['Email'] || '',
                                    system: row['Equipment Requested'] || '',
                                    expectedDays: row['Expected Days Needed'] || '',
                                    beamtime: row['Free Beamtime Access'] || '',
                                    notes: row['Project Description'] || '',
                                    completed: row['Status'] === 'Completed',
                                    completionDate: row['Completion Date'] || '',
                                    daysUsed: row['Days Used'] || ''
                                }
                            };
                        }
                        return null;
                    }).filter(log => log !== null);

                    if (importedLogs.length === 0) {
                        // alert('No valid logs found in Excel file');
                        return;
                    }

                    const shouldAppend = confirm(
                        `Found ${importedLogs.length} log(s) in the file.\n\n` +
                        `Click OK to ADD these to your current logs (${experimentLogs.length} existing).\n` +
                        `Click Cancel to REPLACE all current logs with imported ones.`
                    );

                    if (shouldAppend) {
                        experimentLogs = [...experimentLogs, ...importedLogs];
                        // alert(`Successfully imported ${importedLogs.length} log(s). Total logs: ${experimentLogs.length}`);
                    } else {
                        experimentLogs = importedLogs;
                        // alert(`Successfully imported ${importedLogs.length} log(s). Previous logs replaced.`);
                    }

                    initializeInternalCounter();
                    renderLogs();
                    
                    event.target.value = '';

                } catch (error) {
                    console.error('Error importing Excel:', error);
                    // alert('Error importing Excel file. Please make sure it\'s a valid exported file.');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        renderLogs();
        initializeInternalCounter();
        
        document.getElementById('viewToggle').classList.add('active');

        function showAnalysis() {
            const analysisContent = document.getElementById('analysisContent');
            
            const activeLogs = experimentLogs.filter(log => !log.deleted);
            
            let totalApplications = activeLogs.length;
            let nxctCount = activeLogs.filter(log => log.type === 'NXCT').length;
            let internalCount = activeLogs.filter(log => log.type === 'Internal').length;
            
            let freeDays = 0;
            let paidDays = 0;
            
            activeLogs.forEach(log => {
                const daysUsed = parseFloat(log.data.actualDays || log.data.daysUsed || 0);
                const beamtime = log.data.freeBeamtime || log.data.beamtime || '';
                
                if (beamtime.toLowerCase().includes('free')) {
                    freeDays += daysUsed;
                } else if (beamtime.toLowerCase().includes('paid')) {
                    paidDays += daysUsed;
                }
            });
            
            const statusCounts = {};
            const equipmentUsedCounts = {};
            activeLogs.filter(log => log.type === 'NXCT').forEach(log => {
                const status = log.data.status || 'Acknowledged';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                
                if (log.data.equipmentUsed && log.data.equipmentUsed.length > 0) {
                    log.data.equipmentUsed.forEach(equip => {
                        equipmentUsedCounts[equip] = (equipmentUsedCounts[equip] || 0) + 1;
                    });
                }
            });
            
            const internalLogs = activeLogs.filter(log => log.type === 'Internal');
            let internalDaysUsed = 0;
            let internalCompleted = 0;
            let internalInProgress = 0;
            
            internalLogs.forEach(log => {
                const days = parseFloat(log.data.daysUsed || 0);
                internalDaysUsed += days;
                if (log.data.completed) {
                    internalCompleted++;
                } else {
                    internalInProgress++;
                }
            });
            
            analysisContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f0f5f7; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #2c4a6e;">
                        <div style="font-size: 2em; font-weight: bold; color: #2c4a6e;">${totalApplications}</div>
                        <div style="color: #666; margin-top: 5px;">Total Applications</div>
                    </div>
                    <div style="background: #f0f5f7; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #5d8a9e;">
                        <div style="font-size: 2em; font-weight: bold; color: #5d8a9e;">${nxctCount}</div>
                        <div style="color: #666; margin-top: 5px;">NXCT Applications</div>
                    </div>
                    <div style="background: #f0f5f7; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #8e7a6d;">
                        <div style="font-size: 2em; font-weight: bold; color: #8e7a6d;">${internalCount}</div>
                        <div style="color: #666; margin-top: 5px;">Internal Applications</div>
                    </div>
                    <div style="background: #f0f5f7; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #4a7c59;">
                        <div style="font-size: 2em; font-weight: bold; color: #4a7c59;">${(freeDays + paidDays).toFixed(1)}</div>
                        <div style="color: #666; margin-top: 5px;">Total Days Used</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div>
                        <h3 style="color: #2c4a6e; margin-bottom: 15px; text-align: center;">Free vs Paid Beamtime (Days)</h3>
                        <canvas id="beamtimeChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div>
                        <h3 style="color: #2c4a6e; margin-bottom: 15px; text-align: center;">NXCT Application Status</h3>
                        <canvas id="statusChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div>
                        <h3 style="color: #2c4a6e; margin-bottom: 15px; text-align: center;">Equipment Used</h3>
                        <canvas id="equipmentUsedChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="color: #2c4a6e; margin-bottom: 15px;">NXCT Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><strong>Free Beamtime Days:</strong> ${freeDays.toFixed(1)} days</div>
                        <div><strong>Paid Beamtime Days:</strong> ${paidDays.toFixed(1)} days</div>
                        <div><strong>Free Percentage:</strong> ${(freeDays + paidDays) > 0 ? ((freeDays / (freeDays + paidDays)) * 100).toFixed(1) : 0}%</div>
                        <div><strong>Paid Percentage:</strong> ${(freeDays + paidDays) > 0 ? ((paidDays / (freeDays + paidDays)) * 100).toFixed(1) : 0}%</div>
                    </div>
                    ${Object.keys(equipmentUsedCounts).length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                        <strong style="display: block; margin-bottom: 10px;">Equipment Usage:</strong>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            ${Object.entries(equipmentUsedCounts).map(([equip, count]) => 
                                `<div>‚Ä¢ ${equip}: ${count} time${count > 1 ? 's' : ''}</div>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #f0f5f7; border-radius: 10px; border-left: 4px solid #8e7a6d;">
                    <h3 style="color: #2c4a6e; margin-bottom: 15px;">Internal Applications Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div><strong>Total Internal Apps:</strong> ${internalCount}</div>
                        <div><strong>Completed:</strong> ${internalCompleted}</div>
                        <div><strong>In Progress:</strong> ${internalInProgress}</div>
                        <div><strong>Total Days Used:</strong> ${internalDaysUsed.toFixed(1)} days</div>
                        <div><strong>Average Days/App:</strong> ${internalCount > 0 ? (internalDaysUsed / internalCount).toFixed(1) : 0} days</div>
                    </div>
                </div>
            `;
            
            document.getElementById('analysisModal').classList.add('active');
            
            setTimeout(() => {
                const ctx1 = document.getElementById('beamtimeChart').getContext('2d');
                new Chart(ctx1, {
                    type: 'pie',
                    data: {
                        labels: ['Free', 'Paid'],
                        datasets: [{
                            data: [freeDays, paidDays],
                            backgroundColor: ['#4a7c59', '#b8856d'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                const ctx2 = document.getElementById('statusChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#6d7a8a', '#5d8a9e', '#c9a86a', '#b8856d', '#5d8a6d', '#7d6d9a'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                const ctx3 = document.getElementById('equipmentUsedChart').getContext('2d');
                const hasEquipmentData = Object.keys(equipmentUsedCounts).length > 0;
                
                if (hasEquipmentData) {
                    new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(equipmentUsedCounts),
                            datasets: [{
                                label: 'Times Used',
                                data: Object.values(equipmentUsedCounts),
                                backgroundColor: ['#5d7a9e', '#c9a86a', '#5d8a6d', '#7d6d9a'],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                } else {
                    ctx3.canvas.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #999;">No equipment data yet</div>';
                }
            }, 100);
        }

        function generateTestData() {
            const names = ['Dr. Sarah Johnson', 'Prof. Michael Chen', 'Dr. Emma Williams', 'Dr. James Miller', 'Prof. Lisa Anderson', 
                          'Dr. Robert Taylor', 'Dr. Maria Garcia', 'Prof. David Brown', 'Dr. Jennifer Davis', 'Dr. Christopher Lee',
                          'Prof. Patricia Martinez', 'Dr. Thomas Wilson', 'Dr. Jessica Moore', 'Prof. Daniel Jackson', 'Dr. Karen White',
                          'Dr. Steven Harris', 'Prof. Nancy Martin', 'Dr. Kevin Thompson', 'Dr. Betty Garcia', 'Prof. Mark Robinson'];
            
            const organisations = ['Imperial College London', 'University of Oxford', 'University of Cambridge', 'Manchester University',
                                  'University of Edinburgh', 'King\'s College London', 'Bristol University', 'Southampton University'];
            
            const titles = ['Bone Microstructure Analysis', 'Composite Material Testing', 'Archaeological Artifact Scanning',
                           'Geological Sample Examination', 'Biomedical Implant Study', 'Aerospace Component Testing',
                           'Marine Fossil Investigation', 'Pharmaceutical Formulation Study', 'Polymer Degradation Analysis',
                           'Battery Material Characterization', 'Concrete Porosity Study', 'Wood Density Mapping',
                           'Textile Fiber Analysis', 'Semiconductor Device Inspection', 'Additive Manufacturing Quality Control',
                           'Rock Core Analysis', 'Plant Root Structure Study', 'Ceramic Crack Detection',
                           'Fuel Cell Component Testing', 'Metamaterial Structure Analysis'];
            
            const equipmentOptions = ['Nikon XTH 225', 'Zeiss Xradia 520', 'Nikon XT H 160', 'GE Phoenix v|tome|x L 240', 
                                     'Bruker SkyScan 1272', 'Zeiss Xradia 810 Ultra'];
            
            const statuses = ['Acknowledged', 'Samples Received', 'Scanning', 'Scan Complete', 'Results Ready', 'Data Transferred'];
            const beamtimeTypes = ['Free', 'Paid'];
            
            for (let i = 0; i < 20; i++) {
                const appNumber = `2024-${String(Math.floor(Math.random() * 200) + 1).padStart(3, '0')}`;
                const dateReceived = new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toLocaleDateString('en-GB');
                const name = names[i];
                const org = organisations[Math.floor(Math.random() * organisations.length)];
                const title = titles[i];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const beamtime = beamtimeTypes[Math.floor(Math.random() * beamtimeTypes.length)];
                const equipment = equipmentOptions[Math.floor(Math.random() * equipmentOptions.length)];
                const daysNeeded = Math.floor(Math.random() * 5) + 1;
                const daysUsed = status === 'Scan Complete' || status === 'Results Ready' || status === 'Data Transferred' ? 
                                Math.floor(Math.random() * daysNeeded) + 1 : '';
                
                let equipmentUsed = [];
                if (status === 'Scan Complete' || status === 'Results Ready' || status === 'Data Transferred') {
                    const equipmentTypes = ['Microscope', 'Large Field of View', 'Medium Field of View', 'Other'];
                    const numEquipment = Math.floor(Math.random() * 3) + 1;
                    const shuffled = equipmentTypes.sort(() => 0.5 - Math.random());
                    equipmentUsed = shuffled.slice(0, numEquipment);
                }
                
                const data = {
                    appNumber: appNumber,
                    dateReceived: dateReceived,
                    fullName: name,
                    organisation: org,
                    email: name.toLowerCase().replace(/\s+/g, '.').replace('dr.', '').replace('prof.', '') + '@' + org.toLowerCase().replace(/\s+/g, '').replace('\'', '') + '.ac.uk',
                    projectTitle: title,
                    projectDescription: `This research project aims to investigate ${title.toLowerCase()} using advanced X-ray computed tomography techniques.`,
                    subjectSector: 'Materials Science',
                    typeOfWork: 'Research',
                    freeBeamtime: beamtime,
                    daysNeeded: String(daysNeeded),
                    equipment: equipment,
                    previousExperience: Math.random() > 0.5 ? 'Yes' : 'No',
                    equipmentUsed: equipmentUsed,
                    numSamples: String(Math.floor(Math.random() * 5) + 1),
                    sampleComposition: 'Various materials',
                    sampleDimensions: '10mm x 10mm x 10mm',
                    hazardous: 'No',
                    samplesReady: 'Yes',
                    readyDate: dateReceived,
                    featureSize: '10-100 micrometers',
                    scanningArea: 'Whole sample',
                    analysisHelp: Math.random() > 0.7 ? 'Yes' : 'No',
                    analysisDetails: '',
                    additionalNotes: '',
                    status: status,
                    completionDate: status === 'Data Transferred' ? new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0] : '',
                    actualDays: daysUsed,
                    dataSize: status === 'Results Ready' || status === 'Data Transferred' ? String((Math.random() * 50 + 10).toFixed(1)) : '',
                    analysisTime: status === 'Results Ready' || status === 'Data Transferred' ? String((Math.random() * 20 + 5).toFixed(1)) : '',
                    dataDeleted: 'No',
                    statusLog: [{ status: status, date: new Date().toLocaleString() }]
                };
                
                experimentLogs.unshift({ 
                    type: 'NXCT', 
                    timestamp: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toLocaleString(), 
                    data 
                });
            }
            
            renderLogs();
            // alert('Generated 20 random NXCT applications for testing!');
        }

        function showMaintenance() {
            selectedStartDate = null;
            selectedEndDate = null;
            currentCalendarMonth = new Date();
            renderMaintenanceCalendar();
            renderMaintenanceList();
            document.getElementById('maintenanceModal').classList.add('active');
        }

        function renderMaintenanceCalendar() {
            const calendar = document.getElementById('maintenanceCalendar');
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button onclick="changeMonth(-1)" style="background: #2c4a6e; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚óÄ Prev</button>
                    <strong style="font-size: 1.1em;">${monthNames[month]} ${year}</strong>
                    <button onclick="changeMonth(1)" style="background: #2c4a6e; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Next ‚ñ∂</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #666;">Sun</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #666;">Mon</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #666;">Tue</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #666;">Wed</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #666;">Thu</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #666;">Fri</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #666;">Sat</div>
            `;
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = currentDate.toISOString().split('T')[0];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isToday = currentDate.getTime() === today.getTime();
                const isPast = currentDate < today;
                
                let bgColor = '#fff';
                let textColor = '#333';
                let border = '1px solid #ddd';
                
                if (isPast && !isToday) {
                    bgColor = '#f5f5f5';
                    textColor = '#999';
                }
                
                if (isToday) {
                    border = '2px solid #2c4a6e';
                }
                
                if (selectedStartDate && selectedEndDate) {
                    const startTime = new Date(selectedStartDate).getTime();
                    const endTime = new Date(selectedEndDate).getTime();
                    const currentTime = currentDate.getTime();
                    
                    if (currentTime >= startTime && currentTime <= endTime) {
                        bgColor = '#c9e4ff';
                        textColor = '#2c4a6e';
                    }
                    if (dateStr === selectedStartDate || dateStr === selectedEndDate) {
                        bgColor = '#2c4a6e';
                        textColor = '#fff';
                    }
                } else if (selectedStartDate && dateStr === selectedStartDate) {
                    bgColor = '#2c4a6e';
                    textColor = '#fff';
                }
                
                html += `
                    <div onclick="selectDate('${dateStr}')" 
                         style="text-align: center; padding: 12px; background: ${bgColor}; color: ${textColor}; 
                                border: ${border}; border-radius: 5px; cursor: pointer; transition: all 0.2s;
                                ${isPast && !isToday ? 'cursor: not-allowed;' : ''}"
                         onmouseover="if (!'${isPast}' || '${isToday}') this.style.background='#e0e0e0'; if ('${selectedStartDate}' && !'${selectedEndDate}') this.style.background='#c9e4ff';"
                         onmouseout="this.style.background='${bgColor}'">
                        ${day}
                    </div>
                `;
            }
            
            html += '</div>';
            calendar.innerHTML = html;
            updateDateRangeDisplay();
        }

        function changeMonth(delta) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            renderMaintenanceCalendar();
        }

        function selectDate(dateStr) {
            const selectedDate = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                return;
            }
            
            if (!selectedStartDate) {
                selectedStartDate = dateStr;
                selectedEndDate = null;
            } else if (!selectedEndDate) {
                if (new Date(dateStr) < new Date(selectedStartDate)) {
                    selectedEndDate = selectedStartDate;
                    selectedStartDate = dateStr;
                } else {
                    selectedEndDate = dateStr;
                }
            } else {
                selectedStartDate = dateStr;
                selectedEndDate = null;
            }
            
            renderMaintenanceCalendar();
        }

        function updateDateRangeDisplay() {
            const display = document.getElementById('dateRangeDisplay');
            if (selectedStartDate && selectedEndDate) {
                const start = new Date(selectedStartDate).toLocaleDateString('en-GB');
                const end = new Date(selectedEndDate).toLocaleDateString('en-GB');
                display.textContent = `Selected: ${start} to ${end}`;
                display.style.color = '#4a7c59';
            } else if (selectedStartDate) {
                display.textContent = 'Start date selected. Click on end date.';
                display.style.color = '#c9a86a';
            } else {
                display.textContent = 'Click on calendar to select start date';
                display.style.color = '#2c4a6e';
            }
        }

        function resetCalendar() {
            selectedStartDate = null;
            selectedEndDate = null;
            renderMaintenanceCalendar();
        }

        function addMaintenance() {
            const description = document.getElementById('maintenanceDescription').value.trim();

            if (!selectedStartDate) {
                // alert('Please select a start date');
                return;
            }

            if (!selectedEndDate) {
                // alert('Please select an end date');
                return;
            }

            if (!description) {
                // alert('Please enter a description');
                return;
            }

            maintenanceRecords.push({
                startDate: selectedStartDate,
                endDate: selectedEndDate,
                description,
                addedOn: new Date().toLocaleString()
            });

            document.getElementById('maintenanceDescription').value = '';
            selectedStartDate = null;
            selectedEndDate = null;
            
            renderMaintenanceCalendar();
            renderMaintenanceList();
            // alert('Maintenance scheduled successfully!');
        }

        function renderMaintenanceList() {
            const list = document.getElementById('maintenanceList');
            
            if (maintenanceRecords.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">No maintenance scheduled</p>';
                return;
            }

            const sortedRecords = [...maintenanceRecords].sort((a, b) => 
                new Date(a.startDate) - new Date(b.startDate)
            );

            list.innerHTML = sortedRecords.map((record, index) => {
                const startDate = new Date(record.startDate).toLocaleDateString('en-GB');
                const endDate = new Date(record.endDate).toLocaleDateString('en-GB');
                const isPast = new Date(record.endDate) < new Date();
                
                return `
                    <div style="background: ${isPast ? '#f0f0f0' : '#fff3e0'}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${isPast ? '#999' : '#c94a4a'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="color: ${isPast ? '#666' : '#c94a4a'};">${startDate} - ${endDate}</strong>
                                ${isPast ? '<span style="color: #999; margin-left: 10px; font-size: 0.9em;">(Past)</span>' : ''}
                            </div>
                            <button onclick="deleteMaintenance(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85em;">Delete</button>
                        </div>
                        <div style="color: #555;">${record.description}</div>
                        <div style="color: #999; font-size: 0.85em; margin-top: 8px;">Added: ${record.addedOn}</div>
                    </div>
                `;
            }).join('');
        }

        function deleteMaintenance(index) {
            if (confirm('Are you sure you want to delete this maintenance record?')) {
                maintenanceRecords.splice(index, 1);
                renderMaintenanceList();
            }
        }
    </script>
</body>

</html>

